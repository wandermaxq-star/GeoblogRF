<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç WebSocket —á–∞—Ç–∞ –ø–æ —Ö—ç—à—Ç–µ–≥–∞–º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .chat-container {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        .message .username {
            font-weight: bold;
            color: #007bff;
        }
        .message .time {
            font-size: 0.8em;
            color: #666;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        input, select, button {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç WebSocket —á–∞—Ç–∞ –ø–æ —Ö—ç—à—Ç–µ–≥–∞–º</h1>
    
    <div class="chat-container">
        <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
        <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
        
        <div class="input-group">
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" value="–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
            <input type="number" id="userId" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" value="1">
            <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
    </div>
    
    <div class="chat-container">
        <h2>–ß–∞—Ç</h2>
        <div class="input-group">
            <select id="roomSelect">
                <option value="–ü–æ—Ö–æ–¥—ã">#–ü–æ—Ö–æ–¥—ã</option>
                <option value="–ï–¥–∞">#–ï–¥–∞</option>
                <option value="–ì–æ—Ä–æ–¥–∞">#–ì–æ—Ä–æ–¥–∞</option>
                <option value="–ü—Ä–∏—Ä–æ–¥–∞">#–ü—Ä–∏—Ä–æ–¥–∞</option>
                <option value="–ö—É–ª—å—Ç—É—Ä–∞">#–ö—É–ª—å—Ç—É—Ä–∞</option>
            </select>
            <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</button>
            <button onclick="leaveRoom()">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
        
        <div id="messages" class="messages"></div>
        
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1;">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        let ws = null;
        let currentRoom = null;
        
        function connect() {
            const username = document.getElementById('username').value;
            const userId = document.getElementById('userId').value;
            
            if (!username || !userId) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ ID');
                return;
            }
            
            ws = new WebSocket('ws://localhost:3002');
            
            ws.onopen = function() {
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', true);
                console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
                handleMessage(data);
            };
            
            ws.onclose = function() {
                updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', false);
                console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', false);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function joinRoom() {
            if (!ws) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É');
                return;
            }
            
            const room = document.getElementById('roomSelect').value;
            const username = document.getElementById('username').value;
            const userId = document.getElementById('userId').value;
            
            currentRoom = room;
            
            const message = {
                type: 'join',
                room: room,
                user_id: parseInt(userId),
                username: username,
                avatar: 'assets/images/default-avatar.svg'
            };
            
            ws.send(JSON.stringify(message));
            addMessage('–°–∏—Å—Ç–µ–º–∞', `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ ${room}`, 'system');
        }
        
        function leaveRoom() {
            if (!ws || !currentRoom) {
                alert('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –∫–æ–º–Ω–∞—Ç–µ');
                return;
            }
            
            const message = {
                type: 'leave',
                room: currentRoom
            };
            
            ws.send(JSON.stringify(message));
            addMessage('–°–∏—Å—Ç–µ–º–∞', `–ü–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É ${currentRoom}`, 'system');
            currentRoom = null;
        }
        
        function sendMessage() {
            if (!ws || !currentRoom) {
                alert('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –∫–æ–º–Ω–∞—Ç–µ');
                return;
            }
            
            const messageText = document.getElementById('messageInput').value;
            if (!messageText.trim()) return;
            
            const message = {
                type: 'message',
                room: currentRoom,
                message: messageText
            };
            
            ws.send(JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }
        
        function handleMessage(data) {
            switch (data.type) {
                case 'user_joined':
                    addMessage('–°–∏—Å—Ç–µ–º–∞', `${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É`, 'system');
                    break;
                    
                case 'user_left':
                    addMessage('–°–∏—Å—Ç–µ–º–∞', `${data.username} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`, 'system');
                    break;
                    
                case 'new_message':
                    addMessage(data.username, data.message, 'user', data.created_at);
                    break;
                    
                case 'typing':
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
                    break;
                    
                default:
                    console.log('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:', data);
            }
        }
        
        function addMessage(username, text, type, time) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const timeStr = time ? new Date(time).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <span class="username">${username}</span>
                <span class="time">${timeStr}</span>
                <div>${text}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateStatus(text, connected) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = text;
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
