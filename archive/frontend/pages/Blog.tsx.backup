
import { MirrorGradientContainer, usePanelRegistration } from '../components/MirrorGradientProvider';
import '../styles/GlobalStyles.css';
import '../styles/PageLayout.css';
import React, { useState, useEffect } from 'react';
import BlogSection, { BlogForm } from '../components/Blog/BlogSection';
import BlogConstructor from '../components/Blog/BlogConstructor';
import ParagraphCreator from '../components/Blog/ParagraphCreator';
import StateSelector from '../components/Blog/StateSelector';
import PhotoGallery from '../components/Blog/PhotoGallery';
import MiniPreview from '../components/Blog/MiniPreview';
import BlogPreviewModal from '../components/Blog/BlogPreview';
import ContentAddMenu from '../components/Blog/ContentAddMenu';
import { FaPlus as _FaPlus, FaCog as _FaCog, FaTimes as _FaTimes } from 'react-icons/fa';
import { BookOpen, X } from 'lucide-react';
import { Blog, BlogConstructor as BlogConstructorType, BlogParagraph, StateType, EventData } from '../types/blog';
import { MarkerData } from '../types/marker';
import { Route as RouteData } from '../types/route';
import { useLayoutState } from '../contexts/LayoutContext';
import useFavoriteRoutes from '../hooks/useFavoriteRoutes';
import { getBlogs, createBlog, getUserDrafts } from '../api/blogs';
import { markerService } from '../services/markerService';
import { activityService } from '../services/activityService';
import { useFavorites } from '../contexts/FavoritesContext';
import { blogDraftBus } from '../utils/blogDraftBus';
import BookView from '../components/Blog/BookView';
import BookCreator from '../components/Blog/BookCreator';
import BookDraftsList from '../components/Blog/BookDraftsList';
import BooksList from '../components/Blog/BooksList';
import BlogsGrid from '../components/Blog/BlogsGrid';
import BooksGrid from '../components/Blog/BooksGrid';
import { Book } from '../types/blog';
import { bookService } from '../services/bookService';

const BlogPage: React.FC = () => {
  const isUuid = (value: unknown): value is string =>
    typeof value === 'string' &&
    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89abAB][0-9a-f]{3}-[0-9a-f]{12}$/i.test(value);
  // const { registerPanel, unregisterPanel } = usePanelRegistration();
  const layoutContext = useLayoutState();
  const [leftPanelOpen, setLeftPanelOpen] = useState(false);
  const [rightPanelOpen, setRightPanelOpen] = useState(false);

  const [blogs, setBlogs] = useState<Blog[]>([]);
  const [selectedBlog, setSelectedBlog] = useState<Blog | null>(null);
  const [currentView, setCurrentView] = useState<'list' | 'view' | 'constructor' | 'books'>('list');
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
  const [constructor, setConstructor] = useState<BlogConstructorType>({
    paragraphs: [],
    photos: [],
    links: [],
    title: '',
    preview: '',
    segments: []
  });
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–±–ª–æ–∂–∫–∏
  const [blogCoverData, setBlogCoverData] = useState<{
    title: string;
    description: string;
    gradient: string;
    textColor: string;
    titleFont: string;
    descriptionFont: string;
  } | null>(null);
  const [editingParagraph, setEditingParagraph] = useState<BlogParagraph | null>(null);
  const [showStateSelector, setShowStateSelector] = useState(false);
  const [showPhotoGallery, setShowPhotoGallery] = useState(false);
  const [showBlogPreview, setShowBlogPreview] = useState(false);
  const [showMiniPreview, setShowMiniPreview] = useState(false);
  const [selectedStateType, setSelectedStateType] = useState<StateType>(null);
  const [showContentAddMenu, setShowContentAddMenu] = useState(false);
  const [availableMarkers, setAvailableMarkers] = useState<MarkerData[]>([]);
  const [availableEvents, setAvailableEvents] = useState<EventData[]>([]);
  const [showBookCreator, setShowBookCreator] = useState(false);
  const [selectedBlogForBook, setSelectedBlogForBook] = useState<Blog | null>(null);
  const [showBookDrafts, setShowBookDrafts] = useState(false);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  const [searchQuery, setSearchQuery] = useState('');
  const [filterBy, setFilterBy] = useState('all');
  
  // –ö–Ω–∏–∂–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —á—Ç–µ–Ω–∏—è –±–ª–æ–≥–∞
  
  const favoritesContext = useFavorites();
  const { favoriteRoutes } = useFavoriteRoutes();
  
  // –¢–µ—Å—Ç–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–í–ª–∞–¥–∏–º–∏—Ä)
  const [testRoutes] = useState<RouteData[]>([
    {
      id: '550e8400-e29b-41d4-a716-446655440001',
      title: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä –í–ª–∞–¥–∏–º–∏—Ä–∞',
      description: '–ü–µ—à–µ—Ö–æ–¥–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–º—É —Ü–µ–Ω—Ç—Ä—É –í–ª–∞–¥–∏–º–∏—Ä–∞',
      waypoints: [
        { marker_id: '550e8400-e29b-41d4-a716-446655440002', order_index: 0, notes: '–ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞' },
        { marker_id: '550e8400-e29b-41d4-a716-446655440003', order_index: 1, notes: '–£—Å–ø–µ–Ω—Å–∫–∏–π —Å–æ–±–æ—Ä' }
      ],
      points: [
        { id: 'point-1', title: '–ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞', latitude: 56.1286, longitude: 40.4066 },
        { id: 'point-2', title: '–£—Å–ø–µ–Ω—Å–∫–∏–π —Å–æ–±–æ—Ä', latitude: 56.1290, longitude: 40.4070 }
      ],
      is_user_modified: false,
      used_in_blogs: false
    }
  ]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  useEffect(() => {
    const loadData = async () => {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã
        const markers = await markerService.getAllMarkers();
        setAvailableMarkers(markers);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        if (favoritesContext) {
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º FavoriteEvent –≤ EventData
          const events = (favoritesContext.favoriteEvents || []).map(event => ({
            id: event.id,
            title: event.title,
            description: '',
            date: event.date.toISOString(),
            location: event.location || '',
            is_public: false,
            creator_id: 'user',
            hashtags: [],
            is_user_modified: false,
            used_in_blogs: false
          }));
          setAvailableEvents(events);
        }
      } catch (error) {
        }
    };
    
    loadData();
  }, [favoritesContext]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–ª–æ–≥–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ–∞–ª—å–Ω—ã—Ö –∫—Ä—é—á–∫–æ–≤
  const parseBlogContent = (blog: Blog) => {
    if (!blog.content) return [];

    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –∞–±–∑–∞—Ü—ã
    const paragraphs = blog.content.split('\n\n').filter(p => p.trim());
    // –ü–æ–ª—É—á–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –±–ª–æ–≥–∞
    const relatedMarkers = blog.related_markers || [];
    const relatedRoute = blog.related_route_id;
    
    return paragraphs.map((paragraph, index) => {
      const paragraphText = paragraph.trim();
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ä—é—á–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –∞–±–∑–∞—Ü–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      let hook = undefined;
      
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫—Ä—é—á–æ–∫ –≤ constructor_data
      if (blog.constructor_data?.paragraphs?.[index]?.state) {
        hook = blog.constructor_data.paragraphs[index].state;
        }
      // –ï—Å–ª–∏ –Ω–µ—Ç –∫—Ä—é—á–∫–∞ –≤ constructor_data, —Å–æ–∑–¥–∞–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      else if (index === 0 && relatedMarkers.length > 0) {
        const marker = availableMarkers.find(m => m.id === relatedMarkers[0]);
        if (marker) {
          hook = { type: 'marker' as const, data: { id: marker.id } };
        }
      }
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∞–±–∑–∞—Ü–∞
      else if (index === 1 && relatedRoute) {
        const route = [...(favoriteRoutes || []), ...testRoutes].find(r => r.id === relatedRoute);
        if (route) {
          hook = { type: 'route' as const, data: { id: route.id } };
        }
      }
      // –î–ª—è —Ç—Ä–µ—Ç—å–µ–≥–æ –∞–±–∑–∞—Ü–∞ –∏—â–µ–º —Å–æ–±—ã—Ç–∏–µ –ø–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—é
      else if (index === 2) {
        const foundEvent = availableEvents.find(event => 
          event.title && paragraphText.toLowerCase().includes(event.title.toLowerCase())
        );
        if (foundEvent) {
          hook = { type: 'event' as const, data: { id: foundEvent.id } };
        }
      }

      return {
        id: `paragraph-${index}`,
        text: paragraphText,
        state: hook ? { type: hook.type, data: hook.data } : undefined,
        photos: [],
        links: [],
        order: index
      };

      return {
        id: `paragraph-${index}`,
        text: paragraphText,
        state: hook ? { type: hook.type, data: hook.data } : undefined,
        photos: [],
        links: [],
        order: index
      };
    });
  };

  // –†–µ–Ω–¥–µ—Ä –¥–ª—è —á—Ç–µ–Ω–∏—è: –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–ª–æ–≥ –≤ –æ–±—ä–µ–∫—Ç –∫–Ω–∏–≥–∏

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ LayoutContext –∑–∞–≥—Ä—É–∂–µ–Ω (—Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–ª—É—à–∫—É)
  // if (!layoutContext) {
  //   return (
  //     <div className="min-h-screen flex items-center justify-center">
  //       <div className="text-center">
  //         <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
  //         <p className="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–∫–µ—Ç–∞...</p>
  //       </div>
  //     </div>
  //   );
  // }

  const { routeDataForBlog, markerDataForBlog, setRouteDataForBlog, setMarkerDataForBlog } = layoutContext;

  // useEffect(() => {
  //   registerPanel();
  //   registerPanel();
    
  //   return () => {
  //     unregisterPanel();
  //     unregisterPanel();
  //   };
  // }, []); // –£–±–∏—Ä–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–ª–æ–≥–∏ –∏–∑ API
  useEffect(() => {
    const loadBlogs = async () => {
      try {
        const blogsData = await getBlogs();
        setBlogs(blogsData);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –±–ª–æ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        const testBlog: Blog = {
            id: 'test-blog-1',
            title: '–ì–æ—Ä–æ–¥ –í–ª–∞–¥–∏–º–∏—Ä',
            content: `–ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü –ø—Ä–æ –º–µ—Å—Ç–æ. –Ø –ø–æ—Å–µ—Ç–∏–ª –ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞ –≤–æ –í–ª–∞–¥–∏–º–∏—Ä–µ. –≠—Ç–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–∞–º—è—Ç–Ω–∏–∫ XII –≤–µ–∫–∞.

–í—Ç–æ—Ä–æ–π –∞–±–∑–∞—Ü –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç. –ú—ã –ø—Ä–æ—à–ª–∏ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä –í–ª–∞–¥–∏–º–∏—Ä–∞" –∏ —É–≤–∏–¥–µ–ª–∏ –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ.

–¢—Ä–µ—Ç–∏–π –∞–±–∑–∞—Ü –ø—Ä–æ —Å–æ–±—ã—Ç–∏–µ. –ù–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ "–ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞" –±—ã–ª–æ –æ—á–µ–Ω—å –≤–µ—Å–µ–ª–æ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.

–ß–µ—Ç–≤–µ—Ä—Ç—ã–π –∞–±–∑–∞—Ü –ø—Ä–æ —Å–æ–±–æ—Ä. –£—Å–ø–µ–Ω—Å–∫–∏–π —Å–æ–±–æ—Ä –ø–æ—Ä–∞–∂–∞–µ—Ç —Å–≤–æ–µ–π –∫—Ä–∞—Å–æ—Ç–æ–π –∏ –∏—Å—Ç–æ—Ä–∏–µ–π.

–ü—è—Ç—ã–π –∞–±–∑–∞—Ü –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ü—Ä–æ—Å—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∫—Ä—é—á–∫–æ–≤.`,
            excerpt: '–¢–µ—Å—Ç–æ–≤—ã–π –±–ª–æ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–æ –í–ª–∞–¥–∏–º–∏—Ä–µ',
            author_name: '–¢–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ—Ä',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            status: 'published',
            tags: ['—Ç–µ—Å—Ç', '–≤–ª–∞–¥–∏–º–∏—Ä'],
            related_route_id: '550e8400-e29b-41d4-a716-446655440001',
            related_markers: ['550e8400-e29b-41d4-a716-446655440002', '550e8400-e29b-41d4-a716-446655440003'],
            related_events: ['550e8400-e29b-41d4-a716-446655440004', '550e8400-e29b-41d4-a716-446655440005'],
            constructor_data: {
              paragraphs: [
                {
                  id: 'p1',
                  text: '–ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü –ø—Ä–æ –º–µ—Å—Ç–æ. –Ø –ø–æ—Å–µ—Ç–∏–ª –ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞ –≤–æ –í–ª–∞–¥–∏–º–∏—Ä–µ. –≠—Ç–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–∞–º—è—Ç–Ω–∏–∫ XII –≤–µ–∫–∞.',
                  state: { type: 'marker', data: { id: '550e8400-e29b-41d4-a716-446655440002' } },
                  photos: [],
                  links: [],
                  order: 0
                },
                {
                  id: 'p2',
                  text: '–í—Ç–æ—Ä–æ–π –∞–±–∑–∞—Ü –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç. –ú—ã –ø—Ä–æ—à–ª–∏ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä –í–ª–∞–¥–∏–º–∏—Ä–∞" –∏ —É–≤–∏–¥–µ–ª–∏ –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ.',
                  state: { type: 'route', data: { id: '550e8400-e29b-41d4-a716-446655440001' } },
                  photos: [],
                  links: [],
                  order: 1
                },
                {
                  id: 'p3',
                  text: '–¢—Ä–µ—Ç–∏–π –∞–±–∑–∞—Ü –ø—Ä–æ —Å–æ–±—ã—Ç–∏–µ. –ù–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ "–ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞" –±—ã–ª–æ –æ—á–µ–Ω—å –≤–µ—Å–µ–ª–æ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.',
                  state: { type: 'event', data: { id: '550e8400-e29b-41d4-a716-446655440005' } },
                  photos: [],
                  links: [],
                  order: 2
                },
                {
                  id: 'p4',
                  text: '–ß–µ—Ç–≤–µ—Ä—Ç—ã–π –∞–±–∑–∞—Ü –ø—Ä–æ —Å–æ–±–æ—Ä. –£—Å–ø–µ–Ω—Å–∫–∏–π —Å–æ–±–æ—Ä –ø–æ—Ä–∞–∂–∞–µ—Ç —Å–≤–æ–µ–π –∫—Ä–∞—Å–æ—Ç–æ–π –∏ –∏—Å—Ç–æ—Ä–∏–µ–π.',
                  state: { type: 'marker', data: { id: 'test-marker-2' } },
                  photos: [],
                  links: [],
                  order: 3
                },
                {
                  id: 'p5',
                  text: '–ü—è—Ç—ã–π –∞–±–∑–∞—Ü –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ü—Ä–æ—Å—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∫—Ä—é—á–∫–æ–≤.',
                  state: { type: null, data: null },
                  photos: [],
                  links: [],
                  order: 4
                }
              ],
              photos: [],
              links: [],
              title: '–ì–æ—Ä–æ–¥ –í–ª–∞–¥–∏–º–∏—Ä',
              preview: '–¢–µ—Å—Ç–æ–≤—ã–π –±–ª–æ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–æ –í–ª–∞–¥–∏–º–∏—Ä–µ'
            }
          };
          setBlogs([testBlog, ...blogsData]);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–í–ª–∞–¥–∏–º–∏—Ä)
        setAvailableMarkers([
          {
            id: '550e8400-e29b-41d4-a716-446655440002',
            title: '–ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞',
            description: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–∞–º—è—Ç–Ω–∏–∫ –í–ª–∞–¥–∏–º–∏—Ä–∞',
            latitude: 56.1286,
            longitude: 40.4066,
            category: 'monument',
            rating: 4.8,
            rating_count: 15,
            photo_urls: [],
            hashtags: ['–∏—Å—Ç–æ—Ä–∏—è', '–ø–∞–º—è—Ç–Ω–∏–∫'],
            is_user_modified: false,
            used_in_blogs: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            creator_id: 'test-user',
            author_name: '–¢–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ—Ä',
            likes_count: 0,
            comments_count: 0,
            shares_count: 0
          },
          {
            id: '550e8400-e29b-41d4-a716-446655440003',
            title: '–£—Å–ø–µ–Ω—Å–∫–∏–π —Å–æ–±–æ—Ä',
            description: '–î—Ä–µ–≤–Ω–∏–π —Å–æ–±–æ—Ä –í–ª–∞–¥–∏–º–∏—Ä–∞',
            latitude: 56.1290,
            longitude: 40.4070,
            category: 'church',
            rating: 4.6,
            rating_count: 12,
            photo_urls: [],
            hashtags: ['—Å–æ–±–æ—Ä', '—Ä–µ–ª–∏–≥–∏—è'],
            is_user_modified: false,
            used_in_blogs: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            creator_id: 'test-user',
            author_name: '–¢–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ—Ä',
            likes_count: 0,
            comments_count: 0,
            shares_count: 0
          }
        ]);
        
        setAvailableEvents([
          {
            id: '550e8400-e29b-41d4-a716-446655440004',
            title: '–î–µ–Ω—å –≥–æ—Ä–æ–¥–∞ –í–ª–∞–¥–∏–º–∏—Ä–∞',
            description: '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ —á–µ—Å—Ç—å –¥–Ω—è –≥–æ—Ä–æ–¥–∞ –í–ª–∞–¥–∏–º–∏—Ä–∞',
            date: new Date().toISOString(),
            location: '–¶–µ–Ω—Ç—Ä –í–ª–∞–¥–∏–º–∏—Ä–∞',
            is_user_modified: false,
            used_in_blogs: false
          },
          {
            id: '550e8400-e29b-41d4-a716-446655440005',
            title: '–§–µ—Å—Ç–∏–≤–∞–ª—å "–ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞"',
            description: '–ö—É–ª—å—Ç—É—Ä–Ω—ã–π —Ñ–µ—Å—Ç–∏–≤–∞–ª—å —É –ó–æ–ª–æ—Ç—ã—Ö –≤–æ—Ä–æ—Ç',
            date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
            location: '–ó–æ–ª–æ—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞',
            is_user_modified: false,
            used_in_blogs: false
          }
        ]);
      } catch (error) {
        setBlogs([]);
      }
    };
    
    loadBlogs();
  }, []);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–∫–∏ –∏ —Å–æ–±—ã—Ç–∏—è
  useEffect(() => {
    const loadAvailableData = async () => {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∫–∏
        const markers = await markerService.getAllMarkers();
        setAvailableMarkers(markers);
        
        // TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –∏–∑ API
        setAvailableEvents([]);
      } catch (error) {
        }
    };
    
    loadAvailableData();
  }, []);

  const handleCreate = async (newBlog: Blog) => {
    try {
      const token = localStorage.getItem('token') || localStorage.getItem('authToken') || localStorage.getItem('jwt');
      if (!token) {
        alert('–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.');
        return;
      }

      // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞
      let userId = 'current_user';
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        userId = payload.user_id || payload.id || payload.sub || 'current_user';
      } catch (e) {
        }

      // –°–æ–∑–¥–∞–µ–º –±–ª–æ–≥ —á–µ—Ä–µ–∑ API
      const createdBlog = await createBlog({
        title: newBlog.title,
        content: newBlog.content,
        excerpt: newBlog.preview || '',
        cover_image_url: newBlog.cover_image_url || '',
        tags: newBlog.category ? [newBlog.category] : [],
        related_route_id: null, // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ë–î
        related_markers: [], // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ë–î
        status: 'published'
      });
      
      // –°–æ–∑–¥–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–≥–∞
      await activityService.createActivityHelper(
        'blog_created',
        'blog',
        createdBlog.id,
        {
          title: createdBlog.title,
          category: newBlog.category,
          excerpt: createdBlog.excerpt
        }
      );

      // –°–æ–∑–¥–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      await activityService.createActivityHelper(
        'content_published',
        'blog',
        createdBlog.id,
        {
          title: createdBlog.title,
          userId,
          moderationStatus: 'approved',
          category: newBlog.category
        }
      );
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–ª–æ–≥ –≤ —Å–ø–∏—Å–æ–∫
      setBlogs(prev => [createdBlog, ...prev]);
      setLeftPanelOpen(false);
      // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –º–µ—Ç–∫–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–≥–∞
      setRouteDataForBlog(null);
      setMarkerDataForBlog(null);
    } catch (error: any) {
      const message = error?.response?.data?.error || error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
      alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–ª–æ–≥: ${message}`);
    }
  };

  const handleViewBlog = (blog: Blog) => {
    // –ï—Å–ª–∏ —É –±–ª–æ–≥–∞ –µ—Å—Ç—å constructor_data, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (blog.constructor_data) {
    setSelectedBlog(blog);
      setCurrentView('view');
      return;
    }
    
    // –ï—Å–ª–∏ —É –±–ª–æ–≥–∞ –Ω–µ—Ç constructor_data, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –∏–∑ parseBlogContent
    const blogWithConstructor = {
      ...blog,
      constructor_data: {
        paragraphs: parseBlogContent(blog)
      }
    };
    
    setSelectedBlog(blogWithConstructor);
    setCurrentView('view');
  };
  
  const handleBackToList = () => {
    setCurrentView('list');
    setSelectedBlog(null);
  };

  // –§—É–Ω–∫—Ü–∏–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
  const handleAddParagraph = () => {
    const newParagraph: BlogParagraph = {
      id: Date.now().toString(),
      text: '',
      state: { type: null, data: null },
      photos: [],
      links: [],
      order: constructor.paragraphs.length
    };
    setEditingParagraph(newParagraph);
  };

  const handleSaveParagraph = (paragraph: BlogParagraph) => {
    setConstructor(prev => ({
      ...prev,
      paragraphs: [...prev.paragraphs.filter(p => p.id !== paragraph.id), paragraph]
        .sort((a, b) => a.order - b.order)
    }));
    setEditingParagraph(null);
  };

  const handleCancelParagraph = () => {
    setEditingParagraph(null);
  };

  const handleAddPhoto = () => {
    setShowPhotoGallery(true);
  };

  const handleAddPhotoGroup = () => {
    setShowPhotoGallery(true);
  };

  const handleAddLink = () => {
    const link = prompt('–í–≤–µ–¥–∏—Ç–µ URL —Å—Å—ã–ª–∫–∏:');
    if (link) {
      setConstructor(prev => ({
        ...prev,
        links: [...prev.links, link]
      }));
    }
  };

  const handleAddContent = () => {
    setShowContentAddMenu(true);
  };

  const handleAddMarkerToBlog = async (marker: MarkerData) => {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    try {
      await markerService.updateMarker(marker.id, { used_in_blogs: true });
    } catch (error) {
      }

    const newParagraph: BlogParagraph = {
      id: Date.now().toString(),
      text: `üìç **${marker.title}**\n\n${marker.description || ''}\n\n*–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${marker.category}*`,
      type: 'content',
      state: {
        type: 'marker',
        data: marker
      },
      content: marker,
      photos: [],
      links: [],
      order: constructor.paragraphs.length
    };
    
    setConstructor(prev => ({
      ...prev,
      paragraphs: [...prev.paragraphs, newParagraph]
    }));
  };

  const handleAddRouteToBlog = async (route: RouteData) => {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    try {
      // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
      // await routeService.updateRoute(route.id, { used_in_blogs: true });
      } catch (error) {
      }

    const newParagraph: BlogParagraph = {
      id: Date.now().toString(),
      text: `üõ£Ô∏è **${route.title}**\n\n${route.description || ''}\n\n*–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${route.totalDistance || 0} –∫–º*`,
      type: 'content',
      state: {
        type: 'route',
        data: route
      },
      content: route,
      photos: [],
      links: [],
      order: constructor.paragraphs.length
    };
    
    setConstructor(prev => ({
      ...prev,
      paragraphs: [...prev.paragraphs, newParagraph]
    }));
  };

  const handleAddEventToBlog = async (event: EventData) => {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    try {
      // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
      // await eventService.updateEvent(event.id, { used_in_blogs: true });
      } catch (error) {
      }

    const newParagraph: BlogParagraph = {
      id: Date.now().toString(),
      text: `üìÖ **${event.title}**\n\n${event.description || ''}\n\n*–î–∞—Ç–∞: ${event.date}*`,
      type: 'content',
      state: {
        type: 'event',
        data: event
      },
      content: event,
      photos: [],
      links: [],
      order: constructor.paragraphs.length
    };
    
    setConstructor(prev => ({
      ...prev,
      paragraphs: [...prev.paragraphs, newParagraph]
    }));
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º –∫–Ω–∏–≥
  const handleOpenBookCreator = (blog: Blog) => {
    setSelectedBlogForBook(blog);
    setShowBookCreator(true);
  };

  const handleCloseBookCreator = () => {
    setShowBookCreator(false);
    setSelectedBlogForBook(null);
  };

  const handleSaveBookDraft = (bookData: any) => {
    console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –∫–Ω–∏–≥–∏ –≤ localStorage:', bookData);
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –∫–Ω–∏–≥–∏ –≤ localStorage
    const drafts = JSON.parse(localStorage.getItem('book_drafts') || '[]');
    const newDraft = {
      id: Date.now().toString(),
      ...bookData,
      created_at: new Date().toISOString()
    };
    drafts.push(newDraft);
    localStorage.setItem('book_drafts', JSON.stringify(drafts));
    console.log('‚úÖ –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage. –í—Å–µ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤:', drafts.length);
  };

  const handlePublishBook = (bookData: any) => {
    // –ü—É–±–ª–∏–∫—É–µ–º –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
    (async () => {
      try {
        // –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –∫–Ω–∏–≥ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        try {
          await bookService.initBooksTable();
        } catch (initError) {
          console.log('–¢–∞–±–ª–∏—Ü–∞ –∫–Ω–∏–≥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', initError);
        }

        console.log('üìö –°–æ–∑–¥–∞–µ–º –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ API...');
        const created = await bookService.createBook({
          title: bookData.title,
          category: bookData.category,
          blogIds: bookData.blogs,
          cover: bookData.cover,
          segments: bookData.segments
        });
        
        console.log('‚úÖ –ö–Ω–∏–≥–∞ —Å–æ–∑–¥–∞–Ω–∞:', created);
        alert(`–ö–Ω–∏–≥–∞ "${created.title}" —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!`);
        setShowBookCreator(false);
        setSelectedBlogForBook(null);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –±–ª–æ–≥–æ–≤, —É–±–∏—Ä–∞—è —Ç–µ, —á—Ç–æ –≤–æ—à–ª–∏ –≤ –∫–Ω–∏–≥—É
        const blogsData = await getBlogs();
        const remainingBlogs = blogsData.filter(blog => !bookData.blogs.includes(blog.id));
        setBlogs(remainingBlogs);
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç BooksGrid
        window.dispatchEvent(new CustomEvent('booksUpdated'));
      } catch (e: any) {
        const message = e?.response?.data?.error || e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É';
        alert(`–û—à–∏–±–∫–∞: ${message}`);
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–∏–≥–∏:', e);
      }
    })();
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–µ—Ä–Ω–æ–≤–∏–∫–∞–º–∏ –∫–Ω–∏–≥
  const handleEditDraft = (draft: any) => {
    console.log('‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫:', draft);
    setSelectedBlogForBook(null);
    setShowBookCreator(true);
    // TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤ BookCreator
  };

  const handleDeleteDraft = (draftId: string) => {
    console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫:', draftId);
    // –ß–µ—Ä–Ω–æ–≤–∏–∫ —É–∂–µ —É–¥–∞–ª–µ–Ω –≤ BookDraftsList
  };

  const handlePublishDraft = (draft: any) => {
    console.log('üöÄ –ü—É–±–ª–∏–∫—É–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫:', draft);
    handlePublishBook(draft);
  };

  const handleCloseConstructor = () => {
    setCurrentView('list');
    setEditingParagraph(null);
  };

  const handleStateSelect = (data: any) => {
    if (editingParagraph) {
      const updatedParagraph = {
        ...editingParagraph,
        state: {
          type: selectedStateType,
          data
        }
      };
      setEditingParagraph(updatedParagraph);
    }
    setShowStateSelector(false);
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–µ—Ä–Ω–æ–≤–∏–∫–∞–º–∏
  const handleSaveDraft = async (constructor: BlogConstructorType) => {
    try {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      localStorage.setItem('blog_draft', JSON.stringify(constructor));
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      alert('–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î!');
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞');
    }
  };

  const handleLoadDraft = async () => {
    try {
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
      const savedDraft = localStorage.getItem('blog_draft');
      if (savedDraft) {
        const parsedDraft = JSON.parse(savedDraft);
        setConstructor(parsedDraft);
        alert('–ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage!');
        return;
      }
      
      // –ï—Å–ª–∏ –≤ localStorage –Ω–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –ë–î
      const drafts = await getUserDrafts();
      if (drafts.length > 0) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
        const latestDraft = drafts[0]; // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π
        if (latestDraft.constructor_data) {
          setConstructor(latestDraft.constructor_data);
          } else {
          // –ï—Å–ª–∏ –Ω–µ—Ç constructor_data, —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          setConstructor({
            title: latestDraft.title || '',
            preview: latestDraft.excerpt || '',
            category: latestDraft.tags?.[0] || 'other',
            geoType: 'point',
            tools: [],
            paragraphs: [],
            photos: [],
            links: []
          });
        }
        alert('–ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –ë–î!');
      } else {
        alert('–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞');
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–±–ª–æ–∂–∫–∏
  const handleCoverSave = (coverData: {
    title: string;
    description: string;
    gradient: string;
    textColor: string;
    titleFont: string;
    descriptionFont: string;
  }) => {
    setBlogCoverData(coverData);
    console.log('üíæ –î–∞–Ω–Ω—ã–µ –æ–±–ª–æ–∂–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', coverData);
  };

  const handlePublish = async (ctor: BlogConstructorType) => {
    if (!ctor.title.trim()) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–≥–∞');
      return;
    }
    if (ctor.paragraphs.length === 0 && editingParagraph) {
      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –Ω–µ–∑–∞—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∞–±–∑–∞—Ü ‚Äî –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ –≤ –ø—É–±–ª–∏–∫–∞—Ü–∏—é
      const temp: BlogParagraph = {
        id: editingParagraph.id || Date.now().toString(),
        text: editingParagraph.text,
        state: editingParagraph.state,
        photos: editingParagraph.photos || [],
        links: editingParagraph.links || [],
        order: 0
      } as any;
      ctor = { ...ctor, paragraphs: [temp] };
    }
    if (ctor.paragraphs.length === 0) {
      alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–±–∑–∞—Ü');
      return;
    }

    try {
      const content = ctor.paragraphs
        .sort((a, b) => a.order - b.order)
        .map(p => (p.text || '').replace(/<[^>]*>/g, '')) // –£–±–∏—Ä–∞–µ–º HTML-—Ç–µ–≥–∏
        .join('\n\n');

      // –°–æ–±–∏—Ä–∞–µ–º –∫—Ä—é—á–∫–∏ –∏–∑ –∞–±–∑–∞—Ü–µ–≤
      const relatedMarkers: string[] = [];
      const relatedRoutes: string[] = [];
      const relatedEvents: string[] = [];
      
      ctor.paragraphs.forEach(paragraph => {
        if (paragraph.state?.type === 'marker' && paragraph.state.data?.id) {
          if (isUuid(paragraph.state.data.id)) relatedMarkers.push(paragraph.state.data.id);
        } else if (paragraph.state?.type === 'route' && paragraph.state.data?.id) {
          if (isUuid(paragraph.state.data.id)) relatedRoutes.push(paragraph.state.data.id);
        } else if (paragraph.state?.type === 'event' && paragraph.state.data?.id) {
          relatedEvents.push(paragraph.state.data.id);
        }
      });

      // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ ID, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      // –ö—Ä—é—á–∫–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î

      const created = await createBlog({
        title: ctor.title,
        content,
        excerpt: ctor.preview || '',
        tags: [],
        related_route_id: null, // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ë–î
        related_markers: [], // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ë–î
        status: 'published',
        constructor_data: ctor,
        cover_data: blogCoverData || undefined // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–ª–æ–∂–∫–∏
      });

      setBlogs(prev => [created, ...prev]);
      setSelectedBlog(created);
      setCurrentView('view'); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –±–ª–æ–≥–∞
      setConstructor({ paragraphs: [], photos: [], links: [], title: '', preview: '', segments: [] });
    alert('–ë–ª–æ–≥ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –±–ª–æ–≥–∞');
    }
  };

  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  useEffect(() => {
    const interval = setInterval(() => {
      // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ constructor —á–µ—Ä–µ–∑ –∑–∞–º—ã–∫–∞–Ω–∏–µ
      setConstructor(currentConstructor => {
        if (currentConstructor.title || currentConstructor.paragraphs.length > 0) {
          localStorage.setItem('blog_autosave', JSON.stringify(currentConstructor));
        }
        return currentConstructor; // –ù–µ –∏–∑–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
      });
    }, 30000);

    return () => {
      clearInterval(interval);
    };
  }, []); // –£–±–∏—Ä–∞–µ–º constructor –∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

  return (
    <MirrorGradientContainer className="page-layout-container page-container blogs-mode">
      <div className="page-main-area">
        <div className="page-content-wrapper">
          <div className="page-main-panel relative">
            {/* –ö–Ω–æ–ø–∫–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –±–ª–æ–≥–æ–≤ —Å–ª–µ–≤–∞ */}
            <button
              className="page-side-button left"
              onClick={() => setCurrentView('constructor')}
              title="–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–ª–æ–≥–æ–≤"
            >
              <_FaPlus className="text-blue-600" size={20} />
            </button>

            {/* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–∏–≥–∏ —Å–ø—Ä–∞–≤–∞ */}
            <button
              className="page-side-button right"
              onClick={() => {
                setSelectedBlogForBook(null);
                setShowBookCreator(true);
              }}
              title="–°–æ–∑–¥–∞—Ç—å –∫–Ω–∏–≥—É"
            >
              <BookOpen className="text-green-600" size={20} />
            </button>

            {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
            <div className="h-full relative">
              <div className="map-content-container">
                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
                <div className="map-content-header">
                  <div className="flex items-center justify-between w-full">
                    <h1 className="text-lg font-semibold text-slate-800">–ë–ª–æ–≥–∏</h1>
                  </div>
                </div>

                {/* –û–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */}
                <div className="map-area">
                  <div className="full-height-content p-0">
                    <div className="relative">
              {currentView === 'constructor' ? (
                <div className="flex gap-6">
                  {/* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä */}
                  <div className="w-80 border-r border-gray-200 pr-6">
                    <BlogConstructor
                      onAddParagraph={handleAddParagraph}
                      onAddPhoto={handleAddPhoto}
                      onAddPhotoGroup={handleAddPhotoGroup}
                      onAddLink={handleAddLink}
                      onAddContent={handleAddContent}
                      onPreview={() => setShowMiniPreview(true)}
                      onClose={handleCloseConstructor}
                      constructor={constructor}
                      paragraphs={constructor.paragraphs}
                      onUpdateConstructor={(updates) =>
                        setConstructor(prev => ({ ...prev, ...updates }))
                      }
                      onPublish={() => handlePublish(constructor)}
                      onCoverSave={handleCoverSave}
                    />
                  </div>

                  {/* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –°–æ–∑–¥–∞–Ω–∏–µ –∞–±–∑–∞—Ü–µ–≤ */}
                  <div className="flex-1 overflow-y-auto">
                    {editingParagraph ? (
                      <ParagraphCreator
                        onSave={handleSaveParagraph}
                        onCancel={handleCancelParagraph}
                        initialParagraph={editingParagraph}
                        order={constructor.paragraphs.length + 1}
                        onStateTypeSelect={(type) => {
                          setSelectedStateType(type);
                          if (type) {
                            setShowStateSelector(true);
                          }
                        }}
                        onPublish={() => handlePublish(constructor)}
                        onSaveDraft={() => handleSaveDraft(constructor)}
                        onLoadDraft={handleLoadDraft}
                      />
                    ) : (
                      <div className="flex items-center justify-center h-full">
                        <div className="text-center">
                          <div className="text-gray-500 mb-4">
                            <_FaPlus className="w-16 h-16 mx-auto mb-4 opacity-50" />
                            <div className="text-lg font-medium">–ù–∞—á–Ω–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–ª–æ–≥</div>
                            <div className="text-sm">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∞–±–∑–∞—Ü" –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏</div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              ) : currentView === 'view' && selectedBlog ? (
                <BookView
                  book={{
                    id: `book-${selectedBlog.id}`,
                    title: selectedBlog.title,
                    description: selectedBlog.excerpt,
                    author_id: selectedBlog.author || 'unknown',
                    author_name: selectedBlog.author_name,
                    author_avatar: selectedBlog.author_avatar,
                    cover_image_url: selectedBlog.cover_image_url,
                    category: 'mixed',
                    blogs: [{ ...selectedBlog }],
                    rating: 4.8,
                    ratings_count: 1,
                    views_count: 0,
                    likes_count: 0,
                    is_favorite: false,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    status: 'published'
                  } as Book}
                  onClose={handleBackToList}
                />
              ) : (
                <div className="flex gap-6">
                  {/* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ë–ª–æ–≥–∏ */}
                  <div className="w-1/2 border-r border-gray-200 flex flex-col pr-6">
                    <div className="bg-white border-b border-gray-200 px-4 py-2">
                      <h2 className="text-lg font-bold text-gray-900 mb-2">–ë–õ–û–ì–ò</h2>
                      <div className="flex space-x-4">
                        <div className="flex-1 relative">
                          <input
                            type="text"
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ –±–ª–æ–≥–∞–º..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full pl-3 pr-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                          />
                        </div>
                        <select 
                          value={filterBy}
                          onChange={(e) => setFilterBy(e.target.value)}
                          className="px-2 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                        >
                          <option value="all">–í—Å–µ</option>
                          <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
                          <option value="date">–ü–æ –¥–∞—Ç–µ</option>
                          <option value="views">–ü–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º</option>
                        </select>
                      </div>
                    </div>
                    <div className="flex-1 p-2">
                      <BlogsGrid 
                        blogs={blogs}
                        onViewBlog={handleViewBlog}
                        searchQuery={searchQuery}
                        filterBy={filterBy}
                      />
                    </div>
                  </div>

                  {/* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ö–Ω–∏–≥–∏ */}
                  <div className="w-1/2 flex flex-col">
                    <div className="bg-white border-b border-gray-200 px-4 py-2">
                      <h2 className="text-lg font-bold text-gray-900 mb-2">–ö–ù–ò–ì–ò</h2>
                      <div className="flex space-x-4">
                        <div className="flex-1 relative">
                          <input
                            type="text"
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–Ω–∏–≥–∞–º..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full pl-3 pr-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                          />
                        </div>
                        <select 
                          value={filterBy}
                          onChange={(e) => setFilterBy(e.target.value)}
                          className="px-2 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                        >
                          <option value="all">–í—Å–µ</option>
                          <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
                          <option value="date">–ü–æ –¥–∞—Ç–µ</option>
                          <option value="views">–ü–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º</option>
                        </select>
                      </div>
                    </div>
                    <div className="flex-1 p-2">
                      <BooksGrid 
                        onBookOpen={(book) => handleViewBlog(book.blogs[0] || selectedBlog!)} 
                        searchQuery={searchQuery}
                        filterBy={filterBy}
                      />
                    </div>
                  </div>
                </div>
              )}
            </div>

            {leftPanelOpen && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                    <h2 className="text-xl font-semibold text-gray-900">–°–æ–∑–¥–∞—Ç—å –±–ª–æ–≥</h2>
                    <button
                      onClick={() => setLeftPanelOpen(false)}
                      className="text-gray-500 hover:text-gray-700"
                    >
                      <_FaTimes size={20} />
                    </button>
                  </div>
                  <BlogForm
                    onSave={handleCreate}
                    onCancel={() => setLeftPanelOpen(false)}
                  />
                </div>
              </div>
            )}

            {rightPanelOpen && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 w-full max-w-md">
                  <div className="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                    <h2 className="text-xl font-semibold text-gray-900">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–≥–æ–≤</h2>
                    <button
                      onClick={() => setRightPanelOpen(false)}
                      className="text-gray-500 hover:text-gray-700"
                    >
                      <_FaTimes size={20} />
                    </button>
                  </div>
                  <div className="space-y-4">
                    <p className="text-gray-600">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–≥–æ–≤ –±—É–¥—É—Ç –∑–¥–µ—Å—å</p>
                  </div>
                </div>
              </div>
            )}
        </div>
      </div>

      {/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */}
      {showStateSelector && (
        <StateSelector
          stateType={selectedStateType}
          onSelect={handleStateSelect}
          onClose={() => setShowStateSelector(false)}
          favorites={(function() {
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏
            if (!favoritesContext) {
              return { markers: [], routes: [], events: [] };
            }
            const snapshot = blogDraftBus.getSnapshot();
            // –ú–µ—Ç–∫–∏: –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ç—É–º–±–ª–µ—Ä–æ–º (blogDraftBus)
            const markerList = favoritesContext.favoritePlaces
              .filter(p => snapshot.markers.has(p.id))
              .map(p => ({
                id: p.id,
                name: p.name,
                coordinates: [
                  Number(Array.isArray(p.coordinates) ? p.coordinates[0] : (p.coordinates as any)?.[0]),
                  Number(Array.isArray(p.coordinates) ? p.coordinates[1] : (p.coordinates as any)?.[1])
                ] as [number, number],
                description: p.location,
                category: p.type
              }));
            // –ú–∞—Ä—à—Ä—É—Ç—ã: –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ç—É–º–±–ª–µ—Ä–æ–º
            const routeList = favoritesContext.favoriteRoutes
              .filter(r => snapshot.routes.has(r.id))
              .map(r => ({
                id: r.id,
                name: r.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                waypoints: [],
                distance: r.distance,
                duration: r.duration,
                description: ''
              }));
            // –°–æ–±—ã—Ç–∏—è: –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ç—É–º–±–ª–µ—Ä–æ–º
            const eventList = favoritesContext.favoriteEvents
              .filter(e => snapshot.events.has(e.id))
              .map(e => ({
                id: e.id,
                title: e.title,
                date: (e.date instanceof Date ? e.date : new Date(e.date)).toISOString(),
                location: e.location,
                description: ''
              }));
            return { markers: markerList, routes: routeList, events: eventList };
          })()}
        />
      )}

      {showPhotoGallery && (
        <PhotoGallery
          photos={constructor.photos}
          onClose={() => setShowPhotoGallery(false)}
          onAddPhoto={(url) => {
            setConstructor(prev => ({
              ...prev,
              photos: [...prev.photos, url]
            }));
          }}
          onRemovePhoto={(index) => {
            setConstructor(prev => ({
              ...prev,
              photos: prev.photos.filter((_, i) => i !== index)
            }));
          }}
        />
      )}

      {showBlogPreview && (
        <BlogPreviewModal
          constructor={constructor}
          onClose={() => setShowBlogPreview(false)}
        />
      )}

      {/* –ú–∏–Ω–∏-–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä */}
      <MiniPreview
        constructor={constructor}
        isVisible={showMiniPreview}
        onClose={() => setShowMiniPreview(false)}
      />

      {/* –ú–µ–Ω—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */}
      <ContentAddMenu
        isOpen={showContentAddMenu}
        onClose={() => setShowContentAddMenu(false)}
        onAddMarker={handleAddMarkerToBlog}
        onAddRoute={handleAddRouteToBlog}
        onAddEvent={handleAddEventToBlog}
        availableMarkers={availableMarkers}
        availableRoutes={favoriteRoutes as any}
        availableEvents={availableEvents}
      />

      {/* –°–æ–∑–¥–∞—Ç–µ–ª—å –∫–Ω–∏–≥ */}
      <BookCreator
        isOpen={showBookCreator}
        onClose={handleCloseBookCreator}
        blog={selectedBlogForBook}
        availableBlogs={blogs}
        availableRoutes={[...(favoriteRoutes || []), ...testRoutes]}
        availableMarkers={availableMarkers}
        onSaveDraft={handleSaveBookDraft}
        onPublish={handlePublishBook}
      />

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –∫–Ω–∏–≥ */}
      {showBookDrafts && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg w-full max-w-4xl h-5/6 overflow-hidden">
            <div className="flex justify-between items-center p-6 border-b border-gray-200">
              <h2 className="text-xl font-semibold text-gray-900">–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –∫–Ω–∏–≥</h2>
              <button
                onClick={() => setShowBookDrafts(false)}
                className="text-gray-500 hover:text-gray-700"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
            <div className="p-6 overflow-y-auto h-full">
              <BookDraftsList
                onEditDraft={handleEditDraft}
                onDeleteDraft={handleDeleteDraft}
                onPublishDraft={handlePublishDraft}
              />
            </div>
          </div>
        </div>
              )}
                    </div>

                    {/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */}
                    {showPhotoGallery && (
                      <PhotoGallery
                        photos={constructor.photos}
                        onClose={() => setShowPhotoGallery(false)}
                        onAddPhoto={(url) => {
                          setConstructor(prev => ({
                            ...prev,
                            photos: [...prev.photos, url]
                          }));
                        }}
                        onRemovePhoto={(index) => {
                          setConstructor(prev => ({
                            ...prev,
                            photos: prev.photos.filter((_, i) => i !== index)
                          }));
                        }}
                      />
                    )}

                    {showBlogPreview && (
                      <BlogPreviewModal
                        constructor={constructor}
                        onClose={() => setShowBlogPreview(false)}
                      />
                    )}

                    {/* –ú–∏–Ω–∏-–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä */}
                    <MiniPreview
                      constructor={constructor}
                      isVisible={showMiniPreview}
                      onClose={() => setShowMiniPreview(false)}
                    />

                    {/* –ú–µ–Ω—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */}
                    <ContentAddMenu
                      isOpen={showContentAddMenu}
                      onClose={() => setShowContentAddMenu(false)}
                      onAddMarker={handleAddMarkerToBlog}
                      onAddRoute={handleAddRouteToBlog}
                      onAddEvent={handleAddEventToBlog}
                      availableMarkers={availableMarkers}
                      availableRoutes={favoriteRoutes as any}
                      availableEvents={availableEvents}
                    />

                    {/* –°–æ–∑–¥–∞—Ç–µ–ª—å –±–ª–æ–≥–æ–≤ */}
                    <BlogSection
                      isOpen={showBlogCreator}
                      onClose={handleCloseBlogCreator}
                      onSave={handleSaveBlog}
                      onAddMarker={handleAddMarkerToBlog}
                      onAddRoute={handleAddRouteToBlog}
                      onAddEvent={handleAddEventToBlog}
                      availableMarkers={availableMarkers}
                      availableRoutes={favoriteRoutes as any}
                      availableEvents={availableEvents}
                    />

                    {/* –°–æ–∑–¥–∞—Ç–µ–ª—å –∫–Ω–∏–≥ */}
                    <BookCreator
                      isOpen={showBookCreator}
                      onClose={handleCloseBookCreator}
                      blog={selectedBlogForBook}
                      availableBlogs={blogs}
                      availableRoutes={[...(favoriteRoutes || []), ...testRoutes]}
                      availableMarkers={availableMarkers}
                      onSaveDraft={handleSaveBookDraft}
                      onPublish={handlePublishBook}
                    />

                    {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –∫–Ω–∏–≥ */}
                    {showBookDrafts && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg w-full max-w-4xl h-5/6 overflow-hidden">
                          <div className="flex justify-between items-center p-6 border-b border-gray-200">
                            <h2 className="text-xl font-semibold text-gray-900">–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –∫–Ω–∏–≥</h2>
                            <button
                              onClick={() => setShowBookDrafts(false)}
                              className="text-gray-500 hover:text-gray-700"
                            >
                              <X className="w-6 h-6" />
                            </button>
                          </div>
                          <div className="p-6 overflow-y-auto h-full">
                            <BookDraftsList
                              onEditDraft={handleEditDraft}
                              onDeleteDraft={handleDeleteDraft}
                              onPublishDraft={handlePublishDraft}
                            />
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </MirrorGradientContainer>
  );
};

export default BlogPage;
