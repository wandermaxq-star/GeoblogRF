# OFFLANE_ROAD โ ะัะปะฐะนะฝโะบะฐััั: ยซะะฐัะผะฐะฝะฝัะน ะณะตะพะฑะปะพะณยป

> **ะะพะฝัะตะฟัะธั:** ะฟะพะปะฝะพัะตะฝะฝัะน ะณะตะพ-ะฑะปะพะณะณะธะฝะณ ะฑะตะท ะธะฝัะตัะฝะตัะฐ โ ัะบะฐัะฐะฝะฝัะต ะบะฐััั ัะตะณะธะพะฝะพะฒ, ะธะทะฑัะฐะฝะฝัะต ะผะตัะบะธ, ัะพะทะดะฐะฝะธะต ะบะพะฝัะตะฝัะฐ ะฒ ะฟะพะปะต ั ะฐะฒัะพ-ัะธะฝััะพะฝะธะทะฐัะธะตะน.

---

## 1. ะะดะตั ะธ ัะตะฝะฝะพััั

GeoblogRF โ ััะพ ะฝะต GPS-ะฝะฐะฒะธะณะฐัะพั. ะญัะพ **ะบะฐัะผะฐะฝะฝัะน ะดะฝะตะฒะฝะธะบ ะฟััะตัะตััะฒะตะฝะฝะธะบะฐ**, ะบะพัะพััะน ัะฐะฑะพัะฐะตั ะฑะตะท ัะตัะธ.

### ะขัะธ ััะพะปะฟะฐ ะพัะปะฐะนะฝ-ัะตะถะธะผะฐ:

| ะกัะพะปะฟ | ะงัะพ ะดะตะปะฐะตั | ะะฐะบ ัะฐะฑะพัะฐะตั |
|---|---|---|
| **ะะฐะนัะธ ัะตะฑั** | GPS-ัะพัะบะฐ ะฝะฐ ัะบะฐัะฐะฝะฝะพะน ะบะฐััะต | `navigator.geolocation.watchPosition` + ัะฐะนะปั ะธะท IndexedDB |
| **ะะฐะนัะธ ะธะฝัะตัะตัะฝะพะต** | ะะทะฑัะฐะฝะฝัะต (โ) ะผะตัะบะธ ะธะท ะฟะพััะพะฒ ะธ ัะตะนัะธะฝะณะพะฒ ะฝะฐ ะบะฐััะต | ะะตัะบะธ ะบะตัะธัััััั ะฟัะธ ัะบะฐัะธะฒะฐะฝะธะธ ัะตะณะธะพะฝะฐ |
| **ะกะพะทะดะฐัั ะบะพะฝัะตะฝั** | ะะตัะบะฐ + ัะพัะพ + ะพะฟะธัะฐะฝะธะต + ะบะพะพัะดะธะฝะฐัะฐ โ ัะตัะฝะพะฒะธะบ | ะะฒัะพ-ัะธะฝััะพะฝะธะทะฐัะธั ะฟัะธ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ |

### ะงะตะผ ััะพ ะะ ัะฒะปัะตััั:
- โ GPS-ะฝะฐะฒะธะณะฐัะพั ั ะฟะพัะฐะณะพะฒัะผะธ ะฟะพะดัะบะฐะทะบะฐะผะธ
- โ ะคะพะฝะพะฒะฐั ะทะฐะฟะธัั ััะตะบะฐ (background geolocation ะฝะตะฝะฐะดัะถะฝะฐ ะฝะฐ iOS)
- โ ะะฐะผะตะฝะฐ ะฏะฝะดะตะบั.ะะฐัั/Google Maps ะดะปั ะฝะฐะฒะธะณะฐัะธะธ
- โ ะกะบะฐัะธะฒะฐะฝะธะต zoom 15-18 (ะณะธะณะฐะฑะฐะนัั, ะฑะตััะผััะปะตะฝะฝะพ ะฑะตะท routing)

---

## 2. ะงัะพ ัะบะฐัะธะฒะฐะตััั ะฟัะธ ยซะกะบะฐัะฐัั ัะตะณะธะพะฝยป

ะัะธ ะฝะฐะถะฐัะธะธ ะบะฝะพะฟะบะธ ยซะกะบะฐัะฐััยป ะดะปั ะฒัะฑัะฐะฝะฝะพะณะพ ัะตะณะธะพะฝะฐ (Premium-ััะฝะบัะธั):

| ะะฐะฝะฝัะต | ะฅัะฐะฝะธะปะธัะต | ะัะธะผะตัะฝัะน ะพะฑััะผ |
|---|---|---|
| ะขะฐะนะปั ะบะฐััั OSM (zoom 6โ12) | IndexedDB: `mapTiles` | 5โ15 ะะ ะฝะฐ ัะตะณะธะพะฝ |
| ะกะฒะพะธ ะผะตัะบะธ ะฒ bounds ัะตะณะธะพะฝะฐ | IndexedDB: `userMarkers` | ะฝะตัะบะพะปัะบะพ ะะ |
| ะะทะฑัะฐะฝะฝัะต (โ) ััะถะธะต ะผะตัะบะธ ะฒ bounds | IndexedDB: `favoriteMarkers` | ะฝะตัะบะพะปัะบะพ ะะ |
| ะกะฒะพะธ ะผะฐัััััั ะฒ bounds | IndexedDB: `userRoutes` | ะดะตัััะบะธ ะะ |
| ะกะฒะพะธ ะฟะพััั + ะฟัะตะฒัั ัะพัะพ | IndexedDB: `userPosts` | 1โ5 ะะ |

### ะะพัะตะผั zoom 6โ12:
- Zoom 12: ะพะดะธะฝ ัะฐะนะป โ 10ร10 ะบะผ โ ะฒะธะดะฝั ะฝะฐัะตะปัะฝะฝัะต ะฟัะฝะบัั, ะดะพัะพะณะธ, ัะตะบะธ
- GPS-ัะพัะฝะพััั ะฑัะฐัะทะตัะฐ ยฑ5โ15 ะผ โ ะฟะพะปัะทะพะฒะฐัะตะปั ัะฒะตัะตะฝะฝะพ ะฒะธะดะธั ัะตะฑั ะฝะฐ ะบะฐััะต
- Zoom 14 = ร16 ะฑะพะปััะต ัะฐะนะปะพะฒ = 50โ150 ะะ ะฝะฐ ัะตะณะธะพะฝ (ะธะทะฑััะพัะฝะพ)
- Zoom 12 ะดะพััะฐัะพัะตะฝ ะดะปั ะพัะธะตะฝัะธัะพะฒะบะธ: ยซั ะฝะฐ ััะฐััะต ะ52 ั ะงะตะผะฐะปะฐยป

### ะะพัะตะผั ัะพะปัะบะพ ะธะทะฑัะฐะฝะฝัะต (โ), ะฐ ะฝะต ยซัะพะฟ-20 ะฟะพะฟัะปััะฝััยป:
- ะะพะปัะทะพะฒะฐัะตะปั **ัะฐะผ ะบััะธััะตั** ะฝะฐะฑะพั ะธะฝัะตัะตัะฝัั ะผะตัั ะทะฐัะฐะฝะตะต (ะพะฝะปะฐะนะฝ)
- ะกัะฐะฒะธั โ ะฝะฐ ะผะตัะบะธ ะธะท ะฟะพััะพะฒ, ัะตะนัะธะฝะณะพะฒ, ัะตะบะพะผะตะฝะดะฐัะธะน ะดััะทะตะน
- ะัะธ ัะบะฐัะธะฒะฐะฝะธะธ ัะตะณะธะพะฝะฐ ะฒัะต โ-ะผะตัะบะธ ะฒ bounds ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะฟะฐะดะฐัั ะฒ IndexedDB
- ะะตะฐะปะธััะธัะฝะพ: ะดะฐะถะต ะพะฟััะฝัะน ะฟััะตัะตััะฒะตะฝะฝะธะบ ะดะพะฑะฐะฒะธั โค20 ะธะทะฑัะฐะฝะฝัั ะฝะฐ ะฟะพะตะทะดะบั

---

## 3. ะะพะฝะตัะธะทะฐัะธั (Freemium)

| ะะพะทะผะพะถะฝะพััั | Free | Premium |
|---|---|---|
| ะะธะดะตัั ะบะฐััั ะพัะปะฐะนะฝ (ัะฐะนะปั) | โ | โ |
| GPS-ะฟะพะทะธัะธั ะฝะฐ ะบะฐััะต | โ ะฝะตั ะบะฐััั, GPS ัะฐะฑะพัะฐะตั | โ GPS + ะบะฐััะฐ |
| ะะธะดะตัั ัะฒะพะธ/ะธะทะฑัะฐะฝะฝัะต ะผะตัะบะธ | โ | โ |
| ะกะพะทะดะฐัั ะผะตัะบั + ัะพัะพ ะพัะปะฐะนะฝ | โ๏ธ ยซัะปะตะฟะพะตยป ัะพะทะดะฐะฝะธะต โ ะบะพะพัะดะธะฝะฐัะฐ ะฟะพ GPS, ะบะฐััั ะฝะตั | โ ะฟะพะปะฝะพัะตะฝะฝะพ |
| ะกะพะทะดะฐัั ะฟะพัั/ะผะฐััััั ะพัะปะฐะนะฝ | โ๏ธ ะฑะตะท ะบะฐััั, ะดะพัะตะดะฐะบัะธัะพะฒะฐัั ะฟะพะทะถะต | โ ะฟะพะปะฝะพัะตะฝะฝะพ |
| ะะฒัะพ-ัะธะฝััะพะฝะธะทะฐัะธั | โ | โ |

**ยซะกะปะตะฟะพะน ัะตะถะธะผยป (Free):**
- GPS ะพะฟัะตะดะตะปัะตั ะบะพะพัะดะธะฝะฐัั ัะพัะฝะพ โ ะผะตัะบะฐ ัะพะทะดะฐัััั ั ะฟัะฐะฒะธะปัะฝัะผ `[lat, lon]`
- ะะพะปัะทะพะฒะฐัะตะปั ะดะพะฑะฐะฒะปัะตั ัะพัะพ, ัะตะบัั, ะบะฐัะตะณะพัะธั
- ะะพ ะฝะต ะฒะธะดะธั ะบะฐััั โ ะฝะต ะทะฝะฐะตั, ะณะดะต ััะพะธั ะพัะฝะพัะธัะตะปัะฝะพ ะดะพัะพะณ/ะพะฑัะตะบัะพะฒ
- ะัะธ ัะธะฝััะพะฝะธะทะฐัะธะธ: ัะฒะตะดะพะผะปะตะฝะธะต ยซะะพัะตะดะฐะบัะธััะนัะต ะฒะฐัะธ ะพัะปะฐะนะฝ-ะผะตัะบะธยป

---

## 4. ะััะธัะตะบัััะฐ

### 4.1. ะัะบะตะฝะด API

```
GET /api/offline/region/:regionId/bundle?userId=...
โ {
    userMarkers: [...],         // ะผะตัะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ bounds
    favoriteMarkers: [...],     // โ ะธะทะฑัะฐะฝะฝัะต ะผะตัะบะธ ะฒ bounds
    userRoutes: [...],          // ะผะฐัััััั ะฟะพะปัะทะพะฒะฐัะตะปั
    userPosts: [...],           // ะฟะพััั + thumbnail URLs
    tileManifest: {
      baseUrl: "/api/tiles/{z}/{x}/{y}",
      tiles: [{z, x, y}, ...], // ะบะพะฝะบัะตัะฝัะต ัะฐะนะปั ะดะปั ัะตะณะธะพะฝะฐ
      zoomRange: [6, 12],
      totalSize: 12_000_000,   // ะพัะตะฝะบะฐ ะฒ ะฑะฐะนัะฐั
      tileCount: 2400
    }
  }
```

### 4.2. IndexedDB (ััะพะฝัะตะฝะด)

```
geoblog_offline (v2)
โโโ regions          // keyPath: regionId โ ะผะตัะฐ-ะดะฐะฝะฝัะต ัะบะฐัะฐะฝะฝัั ัะตะณะธะพะฝะพะฒ
โโโ mapTiles         // keyPath: url โ blob ัะฐะนะปะพะฒ, index: regionId
โโโ userMarkers      // keyPath: id โ ะผะตัะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั, index: regionId
โโโ favoriteMarkers  // keyPath: id โ ะธะทะฑัะฐะฝะฝัะต ััะถะธะต ะผะตัะบะธ, index: regionId
โโโ userRoutes       // keyPath: id โ ะผะฐัััััั, index: regionId
โโโ userPosts        // keyPath: id โ ะฟะพััั + ัะพัะพ, index: regionId
โโโ offlineDrafts    // keyPath: id โ ัะตัะฝะพะฒะธะบะธ (ัะพะทะดะฐะฝะพ ะพัะปะฐะนะฝ)
```

### 4.3. ะัะพัะตัั ัะบะฐัะธะฒะฐะฝะธั

```
1. ะะพะปัะทะพะฒะฐัะตะปั ะฒัะฑะธัะฐะตั ัะตะณะธะพะฝ ะฝะฐ SVG-ะบะฐััะต / ะฒ ัะฟะธัะบะต
2. ะัะพะฒะตัะบะฐ Premium-ััะฐัััะฐ
3. GET /api/offline/region/:id/bundle
4. ะกะพััะฐะฝะตะฝะธะต ะผะตัะฐะดะฐะฝะฝัั ะฒ IndexedDB (markers, routes, posts)
5. ะกะบะฐัะธะฒะฐะฝะธะต ัะฐะนะปะพะฒ ะฟะฐัะบะฐะผะธ ะฟะพ 50 ัััะบ โ IndexedDB (ั ะฟัะพะณัะตััะพะผ)
6. ะกัะฐััั ัะตะณะธะพะฝะฐ: 'downloaded' โ ะทะตะปัะฝะฐั ะฟะพะดัะฒะตัะบะฐ ะฝะฐ SVG-ะบะฐััะต
```

### 4.4. ะะฐะฑะพัะฐ ะพัะปะฐะนะฝ

```
1. ะะฑะฝะฐััะถะตะฝะธะต ะพัะปะฐะนะฝะฐ: navigator.onLine === false
2. Leaflet TileLayer โ ะฟะพะดะผะตะฝัะตััั ะฝะฐ IndexedDB-source
3. ะะฐัะบะตัั โ ัะธัััััั ะธะท IndexedDB (ัะฒะพะธ + โ ะธะทะฑัะฐะฝะฝัะต)
4. GPS โ navigator.geolocation.watchPosition โ ะฟัะปััะธััััะฐั ัะพัะบะฐ
5. ะกะพะทะดะฐะฝะธะต ะบะพะฝัะตะฝัะฐ โ offlineDrafts ะฒ IndexedDB
6. ะัะธ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ โ offlineContentQueue ะพัะฟัะฐะฒะปัะตั ัะตัะฝะพะฒะธะบะธ
```

### 4.5. ะะพะผะฟะพะฝะตะฝัั ััะพะฝัะตะฝะดะฐ

```
frontend/src/
โโโ services/
โ   โโโ offlineService.ts          // โ ัะฐััะธัะธัั: bundle download, tile caching
โ   โโโ offlineTileLayer.ts        // ะะะะซะ: Leaflet TileLayer ะธะท IndexedDB
โ   โโโ offlineContentStorage.ts   // ัััะตััะฒัะตั: ัะตัะฝะพะฒะธะบะธ
โ   โโโ offlineContentQueue.ts     // ัััะตััะฒัะตั: ัะธะฝััะพะฝะธะทะฐัะธั
โโโ stores/
โ   โโโ offlineTilesStore.ts       // ัััะตััะฒัะตั: ััะฐัััั ัะบะฐัะธะฒะฐะฝะธั
โโโ components/
โ   โโโ Offline/
โ       โโโ RussiaMapSvg.tsx       // ัััะตััะฒัะตั: SVG-ะบะฐััะฐ (Albers)
โ       โโโ RegionPanel.tsx        // ัััะตััะฒัะตั: ัะฟะธัะพะบ ัะตะณะธะพะฝะพะฒ
โ       โโโ OfflineMapViewer.tsx   // ะะะะซะ: ะพัะปะฐะนะฝ Leaflet-ะบะฐััะฐ
โโโ pages/
โ   โโโ OfflinePage.tsx            // ัััะตััะฒัะตั: ัััะฐะฝะธัะฐ /offline
โ   โโโ Map.tsx                    // ะบะฝะพะฟะบะฐ ยซะัะปะฐะนะฝยป ั dropdown
โโโ data/
    โโโ russiaRegionsPaths.ts      // SVG-ะบะพะฝัััั 85 ัะตะณะธะพะฝะพะฒ
    โโโ russiaRegionsGeo.ts        // ัะตะฝััั, ะฟะปะพัะฐะดะธ, ะคะ
```

---

## 5. ะะทะฑัะฐะฝะฝัะต ะผะตัะบะธ โ ะถะธะทะฝะตะฝะฝัะน ัะธะบะป

```
ะะะะะะ:
  1. ะะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ััะถัั ะผะตัะบั ะฒ ะฟะพััะต / ัะตะนัะธะฝะณะต / ะฝะฐ ะบะฐััะต
  2. ะะฐะถะธะผะฐะตั โ ยซะ ะธะทะฑัะฐะฝะฝะพะตยป โ POST /api/favorites
  3. ะะตัะบะฐ ัะพััะฐะฝะตะฝะฐ ะฝะฐ ัะตัะฒะตัะต ั ะฟัะธะฒัะทะบะพะน ะบ ะฟะพะปัะทะพะฒะฐัะตะปั

ะกะะะงะะะะะะ ะะะะะะะ:
  4. GET /api/offline/region/:id/bundle โ favoriteMarkers[]
  5. ะัะต โ-ะผะตัะบะธ ะฒ bounds ัะตะณะธะพะฝะฐ โ IndexedDB:favoriteMarkers

ะะคะะะะ:
  6. ะัะบััะฒะฐะตั ะพัะปะฐะนะฝ-ะบะฐััั โ ะฒะธะดะธั โ-ะผะตัะบะธ ะฝะฐ ัะฐะนะปะฐั
  7. ะะฐะถะธะผะฐะตั โ popup ั ะพะฟะธัะฐะฝะธะตะผ, ัะพัะพ, ะบะพะพัะดะธะฝะฐัะฐะผะธ, ัะฐัััะพัะฝะธะตะผ
  8. ะะพะถะตั ยซัะปะตะดะพะฒะฐััยป โ ะบะพะผะฟะฐั / ะฝะฐะฟัะฐะฒะปะตะฝะธะต (ะฑะตะท ะผะฐัััััะธะทะฐัะธะธ)
```

---

## 6. ะกะพะทะดะฐะฝะธะต ะบะพะฝัะตะฝัะฐ ะพัะปะฐะนะฝ

### 6.1. ะกะพะทะดะฐะฝะธะต ะผะตัะบะธ

```
1. ะะฐะถะธะผะฐะตั ยซ+ยป ะฝะฐ ะพัะปะฐะนะฝ-ะบะฐััะต
2. GPS ะพะฟัะตะดะตะปัะตั ะบะพะพัะดะธะฝะฐัั โ [lat, lon]
3. ะัะฑะธัะฐะตั ะบะฐัะตะณะพัะธั, ะฟะธัะตั ะพะฟะธัะฐะฝะธะต, ะดะตะปะฐะตั ัะพัะพ ะบะฐะผะตัะพะน
4. โ offlineDrafts ะฒ IndexedDB (type: 'marker')
5. ะัะธ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ โ POST /api/markers โ ัะดะฐะปะตะฝะธะต ะธะท drafts
```

### 6.2. ะกะพะทะดะฐะฝะธะต ะฟะพััะฐ

```
1. ะะฐะถะธะผะฐะตั ยซะะพะฒัะน ะฟะพััยป (offline mode)
2. ะัะธะฒัะทัะฒะฐะตั GPS-ะบะพะพัะดะธะฝะฐัั (ะธะปะธ ะฒัะฑะธัะฐะตั ะธะท ะธะทะฑัะฐะฝะฝัั ะผะตัะพะบ)
3. ะะธัะตั ัะตะบัั, ะดะพะฑะฐะฒะปัะตั ัะพัะพ (ัะถะฐััะต, EXIF-ะบะพะพัะดะธะฝะฐัั)
4. โ offlineDrafts ะฒ IndexedDB (type: 'post')
5. ะัะธ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ โ POST /api/posts โ ัะดะฐะปะตะฝะธะต ะธะท drafts
```

### 6.3. ะะฐะฟะธัั ะผะฐัััััะฐ

```
1. ะะฐะถะธะผะฐะตั ยซะะฐะฟะธัะฐัั ะผะฐัััััยป โ watchPosition ะฐะบัะธะฒะตะฝ
2. ะขะพัะบะธ GPS ะทะฐะฟะธััะฒะฐัััั ะฒ ะฟะฐะผััั ะบะฐะถะดัะต N ัะตะบัะฝะด
3. ะะฐะถะธะผะฐะตั ยซะกัะพะฟยป โ ััะตะบ ัะพััะฐะฝัะฝ ะบะฐะบ offlineDraft (type: 'route')
4. ะัะธ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ โ POST /api/routes โ ัะดะฐะปะตะฝะธะต ะธะท drafts
```

> **ะะฐะถะฝะพ:** ัะพะฝะพะฒะฐั ะทะฐะฟะธัั GPS (background geolocation) ะะ ะธัะฟะพะปัะทัะตััั.
> ะะฐะฑะพัะฐะตั ัะพะปัะบะพ ะฟะพะบะฐ ะฟัะธะปะพะถะตะฝะธะต ะพัะบัััะพ ะฒ ะฑัะฐัะทะตัะต.

---

## 7. UI / ัะพัะบะธ ะฒัะพะดะฐ

### ะะฝะพะฟะบะฐ ยซะัะปะฐะนะฝยป ะฝะฐ ะบะฐััะต (Map.tsx)

ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั โ dropdown ั ะดะฒัะผั ะฟัะฝะบัะฐะผะธ. ะะฐััะธััะตะผ:

```
[ะัะปะฐะนะฝ โผ]
โโโ ๐บ๏ธ  ะะพะบะฐะทะฐัั ะพัะปะฐะนะฝ-ัะปะพะน     // ะฒะบะป/ะฒัะบะป ัะฐะนะปั ะธะท IndexedDB
โโโ โโโโโโโโโโโโโโโโโโโโโ
โโโ ๐ฅ  ะกะบะฐัะฐัั ัะตะบััะธะน ัะตะณะธะพะฝ    // ะพะฟัะตะดะตะปัะตั ัะตะณะธะพะฝ ะฟะพ viewport
โโโ ๐  ะะพะธ ัะบะฐัะฐะฝะฝัะต ัะตะณะธะพะฝั     // ัะฟะธัะพะบ + ัะฟัะฐะฒะปะตะฝะธะต
โโโ โโโโโโโโโโโโโโโโโโโโโ
โโโ ๐  ะัะต ัะตะณะธะพะฝั (/offline)    // ะฟะตัะตัะพะด ะฝะฐ ะฟะพะปะฝะพัะบัะฐะฝะฝัั SVG-ะบะฐััั
```

### ะกััะฐะฝะธัะฐ /offline (OfflinePage.tsx)

ะะพะปะฝะพัะบัะฐะฝะฝะฐั SVG-ะบะฐััะฐ ะะพััะธะธ. ะะตะปัะฝัะผ ะฟะพะดัะฒะตัะตะฝั ัะบะฐัะฐะฝะฝัะต ัะตะณะธะพะฝั.
ะะปะธะบ ะฟะพ ัะตะณะธะพะฝั โ modal ั ะธะฝัะพัะผะฐัะธะตะน + ะบะฝะพะฟะบะพะน ยซะกะบะฐัะฐััยป / ยซะะฑะฝะพะฒะธััยป / ยซะฃะดะฐะปะธััยป.

### ะัะปะฐะนะฝ-ัะตะถะธะผ (ะฐะฒัะพะผะฐัะธัะตัะบะธะน)

ะะพะณะดะฐ `navigator.onLine === false` ะธ ะตััั ัะบะฐัะฐะฝะฝัะต ัะฐะนะปั:
- Leaflet ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะบะปััะฐะตััั ะฝะฐ IndexedDB-ัะฐะนะปั
- ะะพะบะฐะทัะฒะฐัััั ะผะตัะบะธ ะธะท IndexedDB
- ะะฝะพะฟะบะฐ ัะพะทะดะฐะฝะธั ะบะพะฝัะตะฝัะฐ ะดะพัััะฟะฝะฐ
- ะะฝะดะธะบะฐัะพั ยซะัะปะฐะนะฝ-ัะตะถะธะผยป ะฒ ัะณะปั ะบะฐััั

---

## 8. ะะตัะฐะฝะธะบะฐ: ะพะดะฝะฐ ะบะฐััะฐ Leaflet, ะดะฒะฐ ะธััะพัะฝะธะบะฐ ัะฐะนะปะพะฒ

> **ะะปััะตะฒะพะน ะฟัะธะฝัะธะฟ:** ะฟะพะปัะทะพะฒะฐัะตะปั ัะฐะฑะพัะฐะตั ะฝะฐ **ะพะดะฝะพะน ะธ ัะพะน ะถะต ะบะฐััะต Leaflet** โ ะธ ะพะฝะปะฐะนะฝ, ะธ ะพัะปะฐะนะฝ. ะะตะฝัะตััั ัะพะปัะบะพ **ะธััะพัะฝะธะบ ัะฐะนะปะพะฒ**.

### ะงัะพ ะตััั ะฒ ะฟัะพะตะบัะต โ ััะธ ะบะฐััะพัะฝัั ัะบัะฐะฝะฐ:

| ะญะบัะฐะฝ | ะะพะผะฟะพะฝะตะฝั | ะะฐะฑะพัะฐะตั ะพัะปะฐะนะฝ? | ะะฐะทะฝะฐัะตะฝะธะต |
|-------|-----------|------------------|------------|
| **ะัะฝะพะฒะฝะฐั ะบะฐััะฐ** | `Map.tsx` โ Leaflet | โ (ั ะพัะปะฐะนะฝ-ัะฐะนะปะฐะผะธ) | ะัะพัะผะพัั, ะผะตัะบะธ, GPS |
| **ะะปะฐะฝะธัะพะฒัะธะบ** | `Planner.tsx` โ Leaflet + ORS | โ ัะพะปัะบะพ ะพะฝะปะฐะนะฝ | ะะพัััะพะตะฝะธะต ะผะฐัััััะพะฒ (ะฝัะถะตะฝ ORS API) |
| **ะฃะฟัะฐะฒะปะตะฝะธะต** | `OfflinePage.tsx` โ SVG-ะบะฐััะฐ | โ ะฒัะตะณะดะฐ (ััะฐัะธัะฝะฐั SVG) | ะัะฑะพั ัะตะณะธะพะฝะพะฒ ะดะปั ัะบะฐัะธะฒะฐะฝะธั |

ะะปะฐะฝะธัะพะฒัะธะบ (`Planner.tsx`) **ะฒัะตะณะดะฐ ััะตะฑัะตั ะธะฝัะตัะฝะตั** โ ะผะฐัััััะธะทะฐัะธั ะธะดัั ัะตัะตะท ORS API.
ะัะฝะพะฒะฝะฐั ะบะฐััะฐ (`Map.tsx`) โ **ััะพ ะธ ะตััั ะพัะปะฐะนะฝ-ะบะฐััะฐ**, ะฟัะพััะพ ั ะฟะพะดะผะตะฝะพะน ัะปะพั ัะฐะนะปะพะฒ.

### ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั ัะตัะฝะธัะตัะบะธ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Map.tsx (Leaflet)                     โ
โ                                                         โ
โ  ะะะะะะ (ะตััั ะธะฝัะตัะฝะตั):                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ             โ
โ  โ TileLayer: https://tile.openstreetmap.org/{z}/{x}/{y} โ
โ  โ ะะฐัะบะตัั: ะธะท API /api/markers                         โ
โ  โ โ-ะผะตัะบะธ: ะธะท API /api/favorites                       โ
โ  โ Planner: ะดะพัััะฟะตะฝ (ORS API ัะฐะฑะพัะฐะตั)                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ             โ
โ                                                         โ
โ  ะะคะะะะ (ะฝะตั ะธะฝัะตัะฝะตัะฐ + ะตััั ัะบะฐัะฐะฝะฝัะต ัะฐะนะปั):         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ             โ
โ  โ TileLayer: ะธะท IndexedDB (zoom 6-12)     โ โ ะฟะพะดะผะตะฝะฐ! โ
โ  โ ะะฐัะบะตัั: ะธะท IndexedDB:userMarkers       โ             โ
โ  โ โ-ะผะตัะบะธ: ะธะท IndexedDB:favoriteMarkers   โ             โ
โ  โ Planner: ะะะะะกะขะฃะะะ (ัะตัะฐั ะบะฝะพะฟะบะฐ)      โ             โ
โ  โ GPS: navigator.geolocation (ัะฐะฑะพัะฐะตั!)  โ             โ
โ  โ ะกะพะทะดะฐะฝะธะต: โ offlineDrafts (IndexedDB)   โ             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ             โ
โ                                                         โ
โ  ะะะะะฅะะ ะพะฑัะฐัะฝะพ ะฒ ะพะฝะปะฐะนะฝ:                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ             โ
โ  โ TileLayer: ัะฝะพะฒะฐ OSM-ัะตัะฒะตั             โ โ ะพะฑัะฐัะฝะพ!  โ
โ  โ ะะฐัะบะตัั: ะธะท API (ัะฒะตะถะธะต ะดะฐะฝะฝัะต)         โ             โ
โ  โ ะกะธะฝััะพะฝะธะทะฐัะธั: ัะตัะฝะพะฒะธะบะธ โ POST /api/... โ             โ
โ  โ Planner: ัะฝะพะฒะฐ ะดะพัััะฟะตะฝ                 โ             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะปัะทะพะฒะฐัะตะปั ะะ ะทะฐะผะตัะฐะตั ะฟะตัะตะบะปััะตะฝะธั:

1. **ะะตั ะพัะดะตะปัะฝะพะน ยซะพัะปะฐะนะฝ-ะบะฐัััยป** โ ััะพ ัะฐ ะถะต ัะฐะผะฐั ะบะฐััะฐ Leaflet ะฝะฐ `/map`
2. ะะพัะฒะปัะตััั ะฑะฐะฝะฝะตั `๐ด ะัะปะฐะนะฝ-ัะตะถะธะผ โข ะะปัะฐะนัะบะธะน ะบัะฐะน, ะ. ะะปัะฐะน` โ ะธ ะฒัั
3. Zoom ะพะณัะฐะฝะธัะตะฝ ะดะพ 6โ12 (ะทะฐ ะฟัะตะดะตะปะฐะผะธ โ ัะตััะต ัะฐะนะปั ั ะฝะฐะดะฟะธััั ยซะฝะตั ะดะฐะฝะฝััยป)
4. ะะฝะพะฟะบะฐ ยซPlannerยป ัะตัะฐั ั tooltip ยซะขัะตะฑัะตััั ะธะฝัะตัะฝะตัยป
5. ะัะธ ะฒะพะทะฒัะฐัะตะฝะธะธ ะธะฝัะตัะฝะตัะฐ โ ะฑะฐะฝะฝะตั ะธััะตะทะฐะตั, ัะฐะนะปั ัะฝะพะฒะฐ ั OSM-ัะตัะฒะตัะฐ

### ะงัะพ ะฒะธะดะฝะพ ะพัะปะฐะนะฝ vs ะพะฝะปะฐะนะฝ:

| ะญะปะตะผะตะฝั | ะะฝะปะฐะนะฝ | ะัะปะฐะนะฝ |
|---------|--------|--------|
| ะะฐััะฐ (ัะฐะนะปั) | OSM-ัะตัะฒะตั, zoom 1-19 | IndexedDB, zoom 6-12 |
| ะกะฒะพะธ ะผะตัะบะธ | ะะท API, ะฒัะต | ะะท IndexedDB, ัะพะปัะบะพ ัะบะฐัะฐะฝะฝัั ัะตะณะธะพะฝะพะฒ |
| โ-ะผะตัะบะธ | ะะท API, ะฒัะต | ะะท IndexedDB, ัะพะปัะบะพ ัะบะฐัะฐะฝะฝัั ัะตะณะธะพะฝะพะฒ |
| GPS-ัะพัะบะฐ | โ | โ (GPS ะฝะต ะทะฐะฒะธัะธั ะพั ะธะฝัะตัะฝะตัะฐ) |
| ะกะพะทะดะฐะฝะธะต ะผะตัะพะบ | โ POST /api/markers | โ offlineDrafts (IndexedDB) |
| ะกะพะทะดะฐะฝะธะต ะฟะพััะพะฒ | โ POST /api/posts | โ offlineDrafts (IndexedDB) |
| Planner (ะผะฐัััััั) | โ ORS API | โ ะะตะดะพัััะฟะตะฝ |
| ะะพะธัะบ | โ API | โ ะะตะดะพัััะฟะตะฝ |
| ะงะฐั | โ WebSocket | โ ะะตะดะพัััะฟะตะฝ |
| SVG-ะบะฐััะฐ ัะตะณะธะพะฝะพะฒ | โ | โ (ััะฐัะธัะฝะฐั, ะฝะต ะฝัะถะตะฝ ะธะฝัะตัะฝะตั) |

### ะะพะด ะฟะตัะตะบะปััะตะฝะธั (ะบะพะฝัะตะฟั):

```ts
// offlineTileLayer.ts
import L from 'leaflet';

export class OfflineTileLayer extends L.TileLayer {
  async getTileUrl(coords: L.Coords): Promise<string> {
    // ะกะฝะฐัะฐะปะฐ ะฟัะพะฑัะตะผ IndexedDB
    const cached = await getTileFromDB(coords.z, coords.x, coords.y);
    if (cached) return URL.createObjectURL(cached);
    
    // ะัะปะธ ะฝะตั ะฒ ะบะตัะต ะธ ะตััั ะธะฝัะตัะฝะตั โ ััะฐะฝะดะฐััะฝัะน URL
    if (navigator.onLine) {
      return `https://tile.openstreetmap.org/${coords.z}/${coords.x}/${coords.y}.png`;
    }
    
    // ะะตั ะฝะธ ะบะตัะฐ, ะฝะธ ะธะฝัะตัะฝะตัะฐ โ ัะตััะน placeholder
    return '/assets/no-tile.png';
  }
}

// Map.tsx โ ะะะะะะะฅ ะธะทะผะตะฝะตะฝะธะน ะฒ ัะฐะทะผะตัะบะต!
// ะัะพััะพ ะทะฐะผะตะฝัะตะผ ััะฐะฝะดะฐััะฝัะน TileLayer ะฝะฐ OfflineTileLayer
<OfflineTileLayer url="..." />
```

### ะัะพะณะพ โ ะฐััะธัะตะบัััะฐ ะบะฐัั ะฟัะพะตะบัะฐ:

```
GeoblogRF
โโโ /map          โ Leaflet (ะพะฝะปะฐะนะฝ + ะพัะปะฐะนะฝ-fallback)
โ   โโโ TileLayer: OSM / IndexedDB (ะฐะฒัะพะฟะพะดะผะตะฝะฐ)
โ   โโโ ะะฐัะบะตัั: API / IndexedDB (ะฐะฒัะพะฟะพะดะผะตะฝะฐ)
โ   โโโ GPS: ะฒัะตะณะดะฐ ัะฐะฑะพัะฐะตั
โ   โโโ ะกะพะทะดะฐะฝะธะต ะบะพะฝัะตะฝัะฐ: API / offlineDrafts
โ
โโโ /planner      โ Leaflet + ORS (ะขะะะฌะะ ะพะฝะปะฐะนะฝ)
โ   โโโ ะัะธ ะพัะปะฐะนะฝะต: redirect ะฝะฐ /map ั ัะฒะตะดะพะผะปะตะฝะธะตะผ
โ
โโโ /offline       โ SVG-ะบะฐััะฐ (ัะฟัะฐะฒะปะตะฝะธะต ัะบะฐัะธะฒะฐะฝะธะตะผ)
    โโโ 85 ัะตะณะธะพะฝะพะฒ + ััะพะปะธัั
    โโโ ะขะตะผะฐัะธัะตัะบะธะต ะผะฐัััััั
    โโโ ะัะตะณะดะฐ ัะฐะฑะพัะฐะตั (ััะฐัะธัะฝะฐั SVG)
```

---

## 9. ะขัะธ ััะพะฒะฝั ะฟะพะดะฟะธัะตะน ะฝะฐ SVG-ะบะฐััะต (zoom-dependent labels)

ะะฐ ะธะฝัะตัะฐะบัะธะฒะฝะพะน SVG-ะบะฐััะต ัะตะณะธะพะฝะพะฒ ะฟะพะดะฟะธัะธ ะพัะพะฑัะฐะถะฐัััั **ััะตะผั ัะปะพัะผะธ** ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะตะบััะตะณะพ ะทัะผะฐ:

| ะัะผ | ะงัะพ ะฒะธะดะฝะพ | ะะพะป-ะฒะพ | ะััะพัะฝะธะบ ะดะฐะฝะฝัั |
|-----|-----------|--------|----------------|
| **ร1โ2** | ะะฐะทะฒะฐะฝะธั ะพะฑะปะฐััะตะน/ะบัะฐัะฒ | 85 | `russiaRegionsGeo.ts` โ `label` |
| **ร3โ5** | + ะกัะพะปะธัั ัะตะณะธะพะฝะพะฒ (โ) | +85 | `russiaRegionsGeo.ts` โ `capital`, `capitalCoords` |
| **ร6โ12** | + ะะฐะนะพะฝะฝัะต ัะตะฝััั (ยท) | +1500โ2000 | ะัะดััะธะน ัะฐะนะป `russiaDistrictCenters.ts` |

ะขะตัะฝะธัะตัะบะธ ััะพ **ะพะดะธะฝ ะธ ัะพั ะถะต SVG**, ะฟะพะดะฟะธัะธ ัะธะปัััััััั ะฟะพ `currentZoom`.
ะะธะบะฐะบะพะน ะดะพะฟะพะปะฝะธัะตะปัะฝะพะน ะฝะฐะณััะทะบะธ ะฟัะธ ะพะฑะทะพัะฝะพะผ ะทัะผะต โ ัะตะฝะดะตััััั ัะพะปัะบะพ ะฒะธะดะธะผัะต ัะปะพะธ.

### ะะตะฐะปะธะทะฐัะธั ะฒ RussiaMapSvg.tsx:

```tsx
// ะฃัะพะฒะตะฝั 1: ะะฑะปะฐััะธ (ะฒัะตะณะดะฐ)
{showLabels && regionEntries.map(r => <text ...>{r.geo.label}</text>)}

// ะฃัะพะฒะตะฝั 2: ะกัะพะปะธัั (zoom โฅ 3)
{currentZoom >= 3 && regionEntries
  .filter(r => r.geo.capitalCoords)
  .map(r => {
    const [cx, cy] = projectToSvg(...r.geo.capitalCoords);
    return <>
      <circle cx={cx} cy={cy} r={1.2} fill="#1e293b" />
      <text x={cx} y={cy - 2} ...>{r.geo.capital}</text>
    </>;
  })}

// ะฃัะพะฒะตะฝั 3: ะะฐะนะพะฝะฝัะต ัะตะฝััั (zoom โฅ 6) โ ะฑัะดััะตะต
{currentZoom >= 6 && districtCenters
  .filter(d => isInViewBox(d, viewBox))
  .map(d => <text ...>{d.name}</text>)}
```

---

## 10. ะขะตะผะฐัะธัะตัะบะธะต ะผะฐัััััั (Premium-ะบะพะฝัะตะฝั)

### ะะพะฝัะตะฟัะธั

ะขะฐะนะปั ะฝะฐัะตะทะฐัััั **ะฝะต ัะพะปัะบะพ ะฟะพ ะพะฑะปะฐัััะผ, ะฝะพ ะธ ะฟะพ ะณะพัะพะดะฐะผ/ัะฐะนะพะฝะฐะผ**.
ะะฐะถะดัะน ะณะพัะพะด โ ะพัะดะตะปัะฝัะน ะฟะฐะบะตั ัะฐะนะปะพะฒ (zoom 6โ15), ะฝะฐัะตะทะฐะฝะฝัะน ะฝะฐ Ubuntu.
ะะฐััััั = JSON-ะผะฐะฝะธัะตัั, ะพะฑัะตะดะธะฝัััะธะน ะฝัะถะฝัะต ะฟะฐะบะตัั.

### ะกัััะบัััะฐ ะผะฐัััััะฐ:

```json
{
  "id": "golden-ring",
  "name": "ะะพะปะพัะพะต ะะพะปััะพ ะะพััะธะธ",
  "description": "ะะปะฐััะธัะตัะบะธะน ะผะฐััััั ะฟะพ 8 ะณะพัะพะดะฐะผ ะฆะตะฝััะฐะปัะฝะพะน ะะพััะธะธ",
  "cities": [
    { "id": "sergiev_posad", "name": "ะกะตัะณะธะตะฒ ะะพัะฐะด", "coords": [38.13, 56.31], "size_mb": 5 },
    { "id": "pereslavl",     "name": "ะะตัะตัะปะฐะฒะปั-ะะฐะปะตััะบะธะน", "coords": [38.85, 56.74], "size_mb": 4 },
    { "id": "rostov_velikiy","name": "ะะพััะพะฒ ะะตะปะธะบะธะน",  "coords": [39.42, 57.19], "size_mb": 3 },
    { "id": "yaroslavl",     "name": "ะฏัะพัะปะฐะฒะปั",       "coords": [39.89, 57.63], "size_mb": 8 },
    { "id": "kostroma",      "name": "ะะพัััะพะผะฐ",        "coords": [40.93, 57.77], "size_mb": 6 },
    { "id": "ivanovo",       "name": "ะะฒะฐะฝะพะฒะพ",         "coords": [40.97, 56.99], "size_mb": 5 },
    { "id": "suzdal",        "name": "ะกัะทะดะฐะปั",         "coords": [40.45, 56.42], "size_mb": 3 },
    { "id": "vladimir",      "name": "ะะปะฐะดะธะผะธั",        "coords": [40.41, 56.13], "size_mb": 7 }
  ],
  "route_geometry": "...encoded polyline...",
  "total_size_mb": 41,
  "category": "culture",
  "difficulty": "easy",
  "duration_days": "3-5",
  "premium_only": true
}
```

### UI ะผะฐัััััะฐ ะฝะฐ SVG-ะบะฐััะต:

1. ะะฐ ะบะฐััะต ัะธััะตััั **ะฟะพะปะธะปะธะฝะธั** ะผะฐัััััะฐ (ะบัะฐัะฝะฐั ะปะธะฝะธั ัะตัะตะท ะณะพัะพะดะฐ)
2. ะะฐะถะดัะน ะณะพัะพะด โ **ัะพัะบะฐ ั ะฝะฐะทะฒะฐะฝะธะตะผ** + ัะตะบะฑะพะบั
3. ะะพะปัะทะพะฒะฐัะตะปั **ัะฝะธะผะฐะตั ะณะฐะปะพัะบะธ** ั ะณะพัะพะดะพะฒ, ะบะพัะพััะต ะฝะต ัะพัะตั โ ัะฐะทะผะตั ัะผะตะฝััะฐะตััั
4. ะะฝะพะฟะบะฐ **ยซะกะบะฐัะฐัั ะผะฐัััััยป** โ ัะบะฐัะธะฒะฐะตั ัะพะปัะบะพ ะฒัะฑัะฐะฝะฝัะต ะฟะฐะบะตัั
5. ะะฐ ะพัะปะฐะนะฝ-ะบะฐััะต โ ะฟะพะปะฝัะน ะผะฐััััั ั ะฝะฐะฒะธะณะฐัะธะตะน ะผะตะถะดั ัะพัะบะฐะผะธ

### ะะพะฒัะพัะฝะพะต ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ัะฐะนะปะพะฒ:

ะะดะธะฝ ะณะพัะพะด ะฝะฐัะตะทะฐะฝ **ะพะดะธะฝ ัะฐะท** โ ะธัะฟะพะปัะทัะตััั ะฒ ะปัะฑัั ะผะฐัััััะฐั:
- ะฏัะพัะปะฐะฒะปั โ ยซะะพะปะพัะพะต ะะพะปััะพยป + ยซะะพะปะณะฐ ะพั ะธััะพะบะฐ ะดะพ ัััััยป + ยซะัััะบะธะน ะกะตะฒะตัยป
- ะัะบัััะบ โ ยซะขัะฐะฝััะธะฑยป + ยซะะฐะนะบะฐะป-ะบะพะปััะพยป + ยซะะพััะพัะฝะฐั ะกะธะฑะธััยป

### ะะธะทะฝะตั-ะผะพะดะตะปั:

| ะญะปะตะผะตะฝั | Free | Premium |
|---------|------|---------|
| ะัะพัะผะพัั ะผะฐัััััะฐ (ะพะฟะธัะฐะฝะธะต, ัะพัะพ, ะพัะทัะฒั) | โ | โ |
| ะัะพัะผะพัั ะผะฐัััััะฐ ะฝะฐ SVG-ะบะฐััะต | โ | โ |
| ะกะบะฐัะธะฒะฐะฝะธะต ัะฐะนะปะพะฒ ะผะฐัััััะฐ | โ | โ |
| ะกะบะฐัะธะฒะฐะฝะธะต ะณะพัะพะดะพะฒ ะฟะพ ะพัะดะตะปัะฝะพััะธ | โ | โ |
| ะกะพะทะดะฐะฝะธะต ัะฒะพะธั ะผะฐัััััะพะฒ | โ | โ |

### ะัะธะผะตัั ะผะฐัััััะพะฒ (ะบะพะฝัะตะฝั ะฑะตัะบะพะฝะตัะตะฝ):

| ะะฐััััั | ะะพัะพะดะพะฒ | ~ะะฐะทะผะตั | ะะฐัะตะณะพัะธั |
|---------|---------|---------|----------|
| ะะพะปะพัะพะต ะะพะปััะพ | 8 | ~41 ะะ | ะัะปััััะฐ |
| ะขัะฐะฝััะธะฑ (ะะพัะบะฒะฐ โ ะะปะฐะดะธะฒะพััะพะบ) | 12+ | ~90 ะะ | ะัะธะบะปััะตะฝะธั |
| ะะพะตะฝะฝะพ-ะััะทะธะฝัะบะฐั ะดะพัะพะณะฐ | 5 | ~25 ะะ | ะัะธัะพะดะฐ |
| ะะฐะนะบะฐะป-ะบะพะปััะพ | 6 | ~35 ะะ | ะัะธัะพะดะฐ |
| ะัััะบะธะน ะกะตะฒะตั | 7 | ~40 ะะ | ะัะปััััะฐ |
| ะะพะปะณะฐ: ะพั ะธััะพะบะฐ ะดะพ ััััั | 10 | ~60 ะะ | ะะตะบะฐ |
| ะะฐะฒะบะฐะทัะบะธะต ะะธะฝะตัะฐะปัะฝัะต ะะพะดั | 4 | ~20 ะะ | ะะทะดะพัะพะฒะปะตะฝะธะต |
| ะััะผ: ัะถะฝัะน ะฑะตัะตะณ | 6 | ~30 ะะ | ะะพัะต + ะบัะปััััะฐ |
| ะะปัะฐะน: ะงัะนัะบะธะน ััะฐะบั | 5 | ~25 ะะ | ะัะธะบะปััะตะฝะธั |

### ะะฐัะตะทะบะฐ ะณะพัะพะดะพะฒ ะดะปั ะผะฐัััััะพะฒ (Ubuntu):

```bash
# ะะพัะพะด = GeoJSON ะณัะฐะฝะธัั ะณะพัะพะดะฐ + ะฑััะตั 3-5 ะบะผ
python generate_region_tiles.py \
  --region boundaries/cities/yaroslavl.geojson \
  --output cities/yaroslavl.mbtiles \
  --name "ะฏัะพัะปะฐะฒะปั" \
  --min-zoom 6 --max-zoom 15 \
  --buffer 5
```

### API ะผะฐัััััะพะฒ:

```
GET /api/offline/routes                        โ ัะฟะธัะพะบ ัะตะผะฐัะธัะตัะบะธั ะผะฐัััััะพะฒ
GET /api/offline/routes/:routeId               โ ะดะตัะฐะปะธ ะผะฐัััััะฐ (ะณะพัะพะดะฐ, ะณะตะพะผะตััะธั)
GET /api/offline/routes/:routeId/bundle        โ ะฟะฐะบะตั ัะฐะนะปะพะฒ ะดะปั ะฒัะฑัะฐะฝะฝัั ะณะพัะพะดะพะฒ
```

---

## 11. ะะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ (ััะฐะฟั)

### ะญัะฐะฟ 1: ะัะบะตะฝะด API bundle (1-2 ะดะฝั)
- [ ] `GET /api/offline/region/:regionId/bundle` โ ัะพะฑะธัะฐะตั ะผะตัะบะธ, ะธะทะฑัะฐะฝะฝัะต, ะผะฐัััััั, ะฟะพััั
- [ ] `GET /api/offline/region/:regionId/tiles-manifest` โ ัะฟะธัะพะบ ัะฐะนะปะพะฒ ะดะปั ัะตะณะธะพะฝะฐ
- [ ] ะัะพะฒะตัะบะฐ Premium-ััะฐัััะฐ ะฒ middleware

### ะญัะฐะฟ 2: ะะฐััะธัะตะฝะธะต offlineService (2-3 ะดะฝั)
- [ ] ะกะบะฐัะธะฒะฐะฝะธะต bundle โ IndexedDB (ะผะตัะบะธ, ะผะฐัััััั, ะฟะพััั)
- [ ] ะกะบะฐัะธะฒะฐะฝะธะต ัะฐะนะปะพะฒ ะฟะฐัะบะฐะผะธ ั ะฟัะพะณัะตััะพะผ โ IndexedDB
- [ ] ะฃะฟัะฐะฒะปะตะฝะธะต ัะบะฐัะฐะฝะฝัะผะธ ัะตะณะธะพะฝะฐะผะธ (ะพะฑะฝะพะฒะปะตะฝะธะต, ัะดะฐะปะตะฝะธะต)

### ะญัะฐะฟ 3: ะัะปะฐะนะฝ-ัะตะฝะดะตัะธะฝะณ ะบะฐััั (2-3 ะดะฝั)
- [ ] `OfflineTileLayer` โ Leaflet TileLayer ะธะท IndexedDB
- [ ] ะะตะฝะดะตัะธะฝะณ ะผะฐัะบะตัะพะฒ ะธะท IndexedDB (ัะฒะพะธ + โ)
- [ ] ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะบะปััะตะฝะธะต ะพะฝะปะฐะนะฝโะพัะปะฐะนะฝ

### ะญัะฐะฟ 4: GPS ะฝะฐ ะพัะปะฐะนะฝ-ะบะฐััะต (1 ะดะตะฝั)
- [ ] `navigator.geolocation.watchPosition` + ะฟัะปััะธััััะฐั ัะพัะบะฐ
- [ ] ะะฝะพะฟะบะฐ ยซะฆะตะฝััะธัะพะฒะฐัั ะฝะฐ ะผะฝะตยป

### ะญัะฐะฟ 5: ะกะพะทะดะฐะฝะธะต ะบะพะฝัะตะฝัะฐ ะพัะปะฐะนะฝ (2-3 ะดะฝั)
- [ ] ะะฐััะธัะธัั offlineContentStorage ะดะปั ะผะตัะพะบ/ะฟะพััะพะฒ ั ัะพัะพ
- [ ] UI ัะพะทะดะฐะฝะธั ะผะตัะบะธ/ะฟะพััะฐ ะฒ ะพัะปะฐะนะฝ-ัะตะถะธะผะต
- [ ] ะะฒัะพ-ัะธะฝััะพะฝะธะทะฐัะธั ะฟัะธ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ

### ะญัะฐะฟ 6: UI/UX (1-2 ะดะฝั)
- [ ] ะะฐััะธัะธัั dropdown ยซะัะปะฐะนะฝยป ะฒ Map.tsx
- [ ] ะะฝะดะธะบะฐัะพั ะพัะปะฐะนะฝ-ัะตะถะธะผะฐ
- [ ] ะฃะฒะตะดะพะผะปะตะฝะธั ะพ ัะธะฝััะพะฝะธะทะฐัะธะธ
- [ ] ยซะกะปะตะฟะพะน ัะตะถะธะผยป ะดะปั Free (GPS ะฑะตะท ะบะฐััั)

### ะญัะฐะฟ 7: Zoom-dependent labels (1-2 ะดะฝั)
- [ ] ะะพะฑะฐะฒะธัั `capital` + `capitalCoords` ะฒ `russiaRegionsGeo.ts` (85 ััะพะปะธั)
- [ ] ะะตะฝะดะตัะธะฝะณ ััะพะปะธั ะฒ `RussiaMapSvg.tsx` ะฟัะธ zoom โฅ 3
- [ ] ะะพะดะณะพัะพะฒะธัั ััััะบัััั ะดะปั ัะฐะนะพะฝะฝัั ัะตะฝััะพะฒ (`russiaDistrictCenters.ts`)

### ะญัะฐะฟ 8: ะขะตะผะฐัะธัะตัะบะธะต ะผะฐัััััั (3-5 ะดะฝะตะน)
- [ ] JSON-ะผะฐะฝะธัะตััั ะผะฐัััััะพะฒ (ะะพะปะพัะพะต ะะพะปััะพ, ะขัะฐะฝััะธะฑ ะธ ะดั.)
- [ ] API `/api/offline/routes` ะดะปั ัะฟะธัะบะฐ ะธ ะดะตัะฐะปะตะน ะผะฐัััััะพะฒ
- [ ] ะะฐัะตะทะบะฐ ัะฐะนะปะพะฒ ะฟะพ ะณะพัะพะดะฐะผ (GeoJSON ะณะพัะพะดัะบะธั ะณัะฐะฝะธั)
- [ ] UI: ะฟะพะปะธะปะธะฝะธั ะฝะฐ ะบะฐััะต + ัะตะบะฑะพะบัั ะณะพัะพะดะพะฒ + ะบะฝะพะฟะบะฐ ัะบะฐัะธะฒะฐะฝะธั
- [ ] Premium-gate ะดะปั ัะบะฐัะธะฒะฐะฝะธั ะผะฐัััััะพะฒ

---

## 12. ะกััะตััะฒัััะฐั ะธะฝััะฐััััะบัััะฐ

### ะฃะถะต ัะตะฐะปะธะทะพะฒะฐะฝะพ:
- โ SVG-ะบะฐััะฐ ะะพััะธะธ ั 85 ัะตะณะธะพะฝะฐะผะธ (Albers, labels, zoom/pan)
- โ ะกััะฐะฝะธัะฐ `/offline` ั SVG-ะบะฐััะพะน + ะฟะฐะฝะตะปัั ัะตะณะธะพะฝะพะฒ
- โ `offlineService.ts` โ IndexedDB ั region/tile stores
- โ `offlineTilesStore.ts` โ Zustand-ััะพั ัะพ ััะฐัััะฐะผะธ
- โ `DownloadRegionModal` โ UI ัะบะฐัะธะฒะฐะฝะธั (3 ะฒะฐัะธะฐะฝัะฐ)
- โ `offlineContentStorage.ts` โ ัะตัะฝะพะฒะธะบะธ ะผะตัะพะบ/ะผะฐัััััะพะฒ/ะฟะพััะพะฒ
- โ `offlineContentQueue.ts` โ ะพัะตัะตะดั ัะธะฝััะพะฝะธะทะฐัะธะธ
- โ `OfflineOSMRenderer` โ ะฐะดะฐะฟัะตั ะดะปั MBTiles
- โ `/offline-map-test` โ ัะตััะพะฒะฐั ัััะฐะฝะธัะฐ MBTiles-ัะตะฝะดะตัะธะฝะณะฐ
- โ ะะฝะพะฟะบะฐ ยซะัะปะฐะนะฝยป ะฒ Map.tsx ั dropdown-ะผะตะฝั
- โ ะะทะฑัะฐะฝะฝัะต ะผะตัะบะธ (favorites) โ API + UI

### ะัะถะฝะพ ะดะพัะฐะฑะพัะฐัั:
- ๐ `offlineService.downloadRegionData()` โ ัะตะนัะฐั ะทะฐะณะปััะบะธ (ะฒะพะทะฒัะฐัะฐะตั ะฟััััะต ะผะฐััะธะฒั)
- ๐ API `/api/offline/region/:id/bundle` โ ะฝะต ัััะตััะฒัะตั
- ๐ ะขะฐะนะปะพะฒัะน ัะตัะฒะตั ะดะปั ัะบะฐัะธะฒะฐะฝะธั zoom 6โ12 ะดะปั ะบะพะฝะบัะตัะฝะพะณะพ ัะตะณะธะพะฝะฐ
- ๐ IndexedDB-based TileLayer ะดะปั Leaflet
- ๐ GPS-ัะพัะบะฐ ะฝะฐ ะพัะปะฐะนะฝ-ะบะฐััะต
- ๐ Premium-gate ะดะปั ัะบะฐัะธะฒะฐะฝะธั

---

## 13. ะขะตัะฝะธัะตัะบะธะต ะทะฐะผะตัะบะธ

### ะะฐะทะผะตั ัะฐะนะปะพะฒ ะฟะพ zoom-ััะพะฒะฝัะผ (ะพะดะธะฝ ัะตะณะธะพะฝ ััะตะดะฝะตะน ะฟะปะพัะฐะดะธ):

| Zoom | ะขะฐะนะปะพะฒ | ะะฐะทะผะตั | ะะตัะฐะปะธะทะฐัะธั |
|---|---|---|---|
| 6 | ~4 | ~200 ะะ | ะะฑัะธะน ะพะฑะทะพั ะะพััะธะธ |
| 7 | ~8 | ~400 ะะ | ะคะตะดะตัะฐะปัะฝัะน ะพะบััะณ |
| 8 | ~20 | ~1 ะะ | ะะฑะปะฐััั ัะตะปะธะบะพะผ |
| 9 | ~60 | ~3 ะะ | ะััะฟะฝัะต ะณะพัะพะดะฐ ะฒะธะดะฝั |
| 10 | ~200 | ~5 ะะ | ะะฐะนะพะฝะฝัะต ัะตะฝััั |
| 11 | ~600 | ~10 ะะ | ะะพัะพะณะธ, ััะปะฐ |
| 12 | ~2000 | ~15 ะะ | ะฃะปะธัั ะฒ ะณะพัะพะดะฐั |
| **ะัะพะณะพ 6-12** | **~2900** | **~35 ะะ** | ะะพััะฐัะพัะฝะพ ะดะปั ะพัะธะตะฝัะธัะพะฒะบะธ |

### ะะฐะฟะธัั GPS-ััะตะบะฐ:
- ะะฐะฑะพัะฐะตั ะขะะะฌะะ ะฟัะธ ะพัะบัััะพะผ ะฟัะธะปะพะถะตะฝะธะธ (foreground)
- `watchPosition` ั `enableHighAccuracy: true`
- ะะฝัะตัะฒะฐะป ะทะฐะฟะธัะธ: ะบะฐะถะดัะต 5 ัะตะบัะฝะด ะธะปะธ 50 ะผะตััะพะฒ
- Downsample ะฟัะธ ัะพััะฐะฝะตะฝะธะธ (Douglas-Peucker) ะดะปั ัะบะพะฝะพะผะธะธ ะผะตััะฐ

### ะัะปะฐะนะฝ-ะพะฟัะตะดะตะปะตะฝะธะต:
```ts
// ะะพะผะฑะธะฝะฐัะธั navigator.onLine + ะฟัะพะฒะตัะบะฐ fetch
const isOffline = !navigator.onLine || await fetch('/api/ping').catch(() => true);
```

---

## 14. ะัะธัะตัะธะธ ะฟัะธัะผะบะธ (MVP)

- [ ] Premium-ะฟะพะปัะทะพะฒะฐัะตะปั ัะบะฐัะฐะป ยซะะตัะฟัะฑะปะธะบั ะะปัะฐะนยป โ 85 ัะตะณะธะพะฝะพะฒ ะดะพัััะฟะฝั ะดะปั ะฒัะฑะพัะฐ
- [ ] ะัะบะปััะธะป ะธะฝัะตัะฝะตั โ ะฒะธะดะธั ะบะฐััั ัะตะณะธะพะฝะฐ (ัะฐะนะปั zoom 6โ12)
- [ ] ะะธะดะธั ัะฒะพั GPS-ะฟะพะทะธัะธั ะฝะฐ ะบะฐััะต (ะฟัะปััะธััััะฐั ัะพัะบะฐ)
- [ ] ะะธะดะธั ัะฒะพะธ ะผะตัะบะธ + ะธะทะฑัะฐะฝะฝัะต (โ) ะผะตัะบะธ ะฝะฐ ะบะฐััะต
- [ ] ะกะพะทะดะฐัั ะฝะพะฒัั ะผะตัะบั ั ัะพัะพ โ ัะพััะฐะฝะตะฝะพ ะฒ IndexedDB
- [ ] ะะบะปััะธะป ะธะฝัะตัะฝะตั โ ะผะตัะบะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะธะฝััะพะฝะธะทะธัะพะฒะฐะฝะฐ
- [ ] Free-ะฟะพะปัะทะพะฒะฐัะตะปั ะฑะตะท ัะบะฐัะฐะฝะฝัั ะบะฐัั: ะผะพะถะตั ัะพะทะดะฐัั ะผะตัะบั ะฟะพ GPS-ะบะพะพัะดะธะฝะฐัะฐะผ, ะฝะพ ะบะฐััั ะฝะต ะฒะธะดะธั

---

## 15. ะะธะทะฝะตะฝะฝัะน ัะธะบะป ะฟะพัะปะต ัะบะฐัะธะฒะฐะฝะธั

> ะััั ัะฐะท ะถะธะทะฝะธ ะดะฐะฝะฝัั โ ะพั ัะบะฐัะธะฒะฐะฝะธั ะดะพ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั.

### ะคะฐะทะฐ 1: ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะพัะปะฐะนะฝ (ัะดัะพ)

```
ะะพะปัะทะพะฒะฐัะตะปั ัะตัะฐะป ะฒ ะณะพัั, ะธะฝัะตัะฝะตัะฐ ะฝะตั
โโโ 1. ะัะบััะฒะฐะตั /map โ ะฐะฒัะพะดะตัะตะบั ะพัะปะฐะนะฝะฐ
โ   โโโ Leaflet ะฟะพะดะผะตะฝัะตั TileLayer โ IndexedDB
โ   โโโ ะะฐัะบะตัั ะธะท IndexedDB (ัะฒะพะธ + โ)
โ   โโโ ะะฐะฝะฝะตั ยซะัะปะฐะนะฝ-ัะตะถะธะผ โข ะะปัะฐะนัะบะธะน ะบัะฐะน + ะ. ะะปัะฐะนยป
โ
โโโ 2. ะะธะดะธั ัะตะฑั ะฝะฐ ะบะฐััะต
โ   โโโ GPS โ ะฟัะปััะธััััะฐั ัะพัะบะฐ, ะบะพะพัะดะธะฝะฐัั ะฒ ัะณะปั
โ
โโโ 3. ะัะตั ะธะฝัะตัะตัะฝะพะต
โ   โโโ ะขะฐะฟ ะฟะพ โ-ะผะตัะบะต โ popup (ะพะฟะธัะฐะฝะธะต, ัะพัะพ, ัะฐัััะพัะฝะธะต)
โ   โโโ ยซะะฐะฟัะฐะฒะปะตะฝะธะตยป โ ะบะพะผะฟะฐั ะบ ัะพัะบะต (ะะ ะผะฐัััััะธะทะฐัะธั)
โ
โโโ 4. ะกะพะทะดะฐัั ะบะพะฝัะตะฝั
โ   โโโ ะะพะฒะฐั ะผะตัะบะฐ (GPS + ัะพัะพ + ัะตะบัั) โ offlineDrafts
โ   โโโ ะะพะฒัะน ะฟะพัั (ัะตะบัั + ัะพัะพ) โ offlineDrafts
โ   โโโ ะะฐะฟะธัั ััะตะบะฐ (watchPosition) โ offlineDrafts
โ
โโโ 5. ะฃะฟัะฐะฒะปะตะฝะธะต ััะฐะฝะธะปะธัะตะผ
    โโโ ยซะกะบะฐัะฐะฝะพยป โ ัะฟะธัะพะบ ัะตะณะธะพะฝะพะฒ + ัะฐะทะผะตั + ะดะฐัะฐ
```

**ะัะฐะฝัั:**
- ะะฐ ะณัะฐะฝะธัะต ะดะฒัั ัะบะฐัะฐะฝะฝัั ัะตะณะธะพะฝะพะฒ ัะฐะนะปั ะฑะตััะพะฒะฝะพ ัััะบััััั (ะบะปัั `{z}/{x}/{y}` โ ะตัะปะธ ัะฐะนะป ะตััั ะฒ ะพะฑะพะธั ัะตะณะธะพะฝะฐั, ััะฐะฝะธััั ะพะดะฝะฐ ะบะพะฟะธั โ ะดะตะดัะฟะปะธะบะฐัะธั)
- ะะฐะบัะธะผัะผ ัะตัะฝะพะฒะธะบะพะฒ: ะฑะตะท ะปะธะผะธัะฐ, ะฝะพ ะฟัะตะดัะฟัะตะถะดะตะฝะธะต ะฟัะธ >50 (IndexedDB ะฝะต ัะตะทะธะฝะพะฒัะน)
- ะะฐ ะฟัะตะดะตะปะฐะผะธ zoom 6-12 โ ัะตััะน placeholder ยซะะตั ะดะฐะฝะฝัั ะดะปั ััะพะณะพ ะผะฐัััะฐะฑะฐยป

### ะคะฐะทะฐ 2: ะะพะทะฒัะฐั ะฒ ะพะฝะปะฐะนะฝ โ ัะธะฝััะพะฝะธะทะฐัะธั

```
ะะฝัะตัะฝะตั ะฒะตัะฝัะปัั (Wi-Fi ะฒ ะพัะตะปะต, ะผะพะฑะธะปัะฝะฐั ัะตัั)
โโโ 1. ะะฒัะพะดะตัะตะบั ะพะฝะปะฐะนะฝะฐ (navigator.onLine + fetch /api/ping)
โ
โโโ 2. ะกะธะฝััะพะฝะธะทะฐัะธั ัะตัะฝะพะฒะธะบะพะฒ (ะพัะตัะตะดั)
โ   โโโ offlineDrafts โ POST /api/markers (ัะพะทะดะฐะฝะฝัะต ะผะตัะบะธ)
โ   โโโ offlineDrafts โ POST /api/posts (ะฟะพััั ั ัะพัะพ)
โ   โโโ offlineDrafts โ POST /api/routes (ะทะฐะฟะธัะฐะฝะฝัะต ััะตะบะธ)
โ   โโโ ะัะพะณัะตัั: ยซะกะธะฝััะพะฝะธะทะฐัะธั 3/7... ะะฐะณััะทะบะฐ ัะพัะพ 2/5...ยป
โ
โโโ 3. ะะฑัะฐะฑะพัะบะฐ ะบะพะฝัะปะธะบัะพะฒ
โ   โโโ ะกััะฐัะตะณะธั: last-write-wins (ะดะปั MVP)
โ   โโโ โ-ะผะตัะบะฐ ัะดะฐะปะตะฝะฐ ะฐะฒัะพัะพะผ โ ัะฒะตะดะพะผะธัั ะฟะพะปัะทะพะฒะฐัะตะปั
โ   โโโ ะ ะฑัะดััะตะผ: ัััะฝะพะต ัะฐะทัะตัะตะฝะธะต ะบะพะฝัะปะธะบัะพะฒ
โ
โโโ 4. ะะฑะฝะพะฒะปะตะฝะธะต ะบะตัะฐ
โ   โโโ ะะพะฒัะต โ-ะผะตัะบะธ (ะดะพะฑะฐะฒะปะตะฝั ะพะฝะปะฐะนะฝ) โ ะดะพะบะฐัะฐัั ะฒ IndexedDB
โ   โโโ ะกัะฐััะต โ-ะผะตัะบะธ (ัะดะฐะปะตะฝั ะธะท ะธะทะฑัะฐะฝะฝัั) โ ัะดะฐะปะธัั
โ   โโโ ะขะฐะนะปั ะะ ะพะฑะฝะพะฒะปััััั ะฐะฒัะพะผะฐัะธัะตัะบะธ (OSM ะผะตะฝัะตััั ัะตะดะบะพ)
โ
โโโ 5. ะฃะฒะตะดะพะผะปะตะฝะธั
    โโโ ยซโ 3 ะผะตัะบะธ, 1 ะฟะพัั ะธ 2 ััะตะบะฐ ัะธะฝััะพะฝะธะทะธัะพะฒะฐะฝัยป
    โโโ ยซโ๏ธ 1 ะผะตัะบะฐ ััะตะฑัะตั ะฒะฝะธะผะฐะฝะธัยป (ะบะพะฝัะปะธะบั)
    โโโ ยซ๐ฅ 5 ะฝะพะฒัั โ-ะผะตัะพะบ ะดะพัััะฟะฝั ะดะปั ัะบะฐัะธะฒะฐะฝะธัยป
```

**ะกะธะฝััะพะฝะธะทะฐัะธั ัะพัะพ:**
- ะคะพัะพ โค5 ะะ โ ััะฐะทั ะฟัะธ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ
- ะคะพัะพ >5 ะะ โ ัะพะปัะบะพ ะฟะพ Wi-Fi (ะฝะฐัััะพะนะบะฐ ะฒ ะฟัะพัะธะปะต)
- ะงะฐััะธัะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั: ะตัะปะธ ัะตัั ะฟัะพะฟะฐะปะฐ ะฟะพััะตะดะธ ะฟัะพัะตััะฐ โ ะพัะตัะตะดั ัะพััะฐะฝัะตััั, ะฟัะพะดะพะปะถะธั ะฟะพะทะถะต

### ะคะฐะทะฐ 3: ะฃะฟัะฐะฒะปะตะฝะธะต ััะฐะฝะธะปะธัะตะผ

```
ะะพะปัะทะพะฒะฐัะตะปั ัะบะฐัะฐะป 5 ัะตะณะธะพะฝะพะฒ = ~150-200 ะะ
โโโ 1. ะะธะผะธัั ะฑัะฐัะทะตัะฐ
โ   โโโ Chrome: ~80% ะพั ัะฒะพะฑะพะดะฝะพะณะพ ะผะตััะฐ ะฝะฐ ะดะธัะบะต
โ   โโโ Safari: ะถัััะบะธะน ะปะธะผะธั ~1 ะะ, ัะฟัะฐัะธะฒะฐะตั ัะฐะทัะตัะตะฝะธะต
โ   โโโ Firefox: ะฑะตะท ะปะธะผะธัะฐ, ะฝะพ ะฟัะตะดัะฟัะตะถะดะฐะตั
โ   โโโ โ๏ธ ะัะฐัะทะตั ะผะพะถะตั ัะดะฐะปะธัั ะดะฐะฝะฝัะต ะฟัะธ ะฝะตัะฒะฐัะบะต ะผะตััะฐ!
โ
โโโ 2. ะะฑะฝะพะฒะปะตะฝะธะต ะดะฐะฝะฝัั
โ   โโโ ะขะฐะนะปั: ะฑะตะท ะฐะฒัะพะพะฑะฝะพะฒะปะตะฝะธั (ะบะฝะพะฟะบะฐ ยซะะฑะฝะพะฒะธัั ะบะฐัััยป)
โ   โโโ ะะตัะบะธ: ะพะฑะฝะพะฒะปััััั ะฟัะธ ะบะฐะถะดะพะผ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ
โ   โโโ ะงะตัะฝะพะฒะธะบะธ: ะฝะต ัะดะฐะปััััั ะดะพ ัะธะฝััะพะฝะธะทะฐัะธะธ
โ
โโโ 3. ะฃะดะฐะปะตะฝะธะต ัะตะณะธะพะฝะฐ
โ   โโโ ะฃะดะฐะปัะตั ัะฐะนะปั + ะผะตัะบะธ + ะผะฐัััััั ะฟะพ regionId
โ   โโโ ะัะปะธ ัะฐะนะป {z/x/y} ะธัะฟะพะปัะทัะตััั ะดะฒัะผั ัะตะณะธะพะฝะฐะผะธ โ ะะ ัะดะฐะปััั
โ   โโโ ะงะตัะฝะพะฒะธะบะธ ะะ ัะดะฐะปััััั (ะพะฝะธ ะฟัะธะฒัะทะฐะฝั ะบ ะฟะพะปัะทะพะฒะฐัะตะปั, ะฝะต ะบ ัะตะณะธะพะฝั)
โ
โโโ 4. ะกัะฐัะธััะธะบะฐ (UI)
    โโโ ะะฑัะธะน ัะฐะทะผะตั: 187 ะะ
    โโโ ะะพ ัะตะณะธะพะฝะฐะผ: ะะปัะฐะนัะบะธะน ะบัะฐะน (45 ะะ), ะะพัะบะฒะฐ (12 ะะ)...
    โโโ ะะพัััะฟะฝะพ ะฝะฐ ััััะพะนััะฒะต: ~800 ะะ
```

### ะคะฐะทะฐ 4: ะะบััะฐะปัะฝะพััั ะดะฐะฝะฝัั

```
ะัะพััะป ะผะตััั. ะะพะปัะทะพะฒะฐัะตะปั ะทะฐััะป ัะฝะพะฒะฐ.
โโโ ะขะฐะนะปั zoom 6-12 โ ะฐะบััะฐะปัะฝั (OSM ะผะตะฝัะตััั ะผะตะดะปะตะฝะฝะพ)
โโโ ะกะฒะพะธ ะผะตัะบะธ โ ะผะพะณัั ะฑััั ะธะทะผะตะฝะตะฝั ั ะดััะณะพะณะพ ััััะพะนััะฒะฐ
โโโ โ-ะผะตัะบะธ โ ะฐะฒัะพั ะผะพะณ ัะดะฐะปะธัั, ะบะพะฝัะตะฝั ะผะพะณ ะธะทะผะตะฝะธัััั
โโโ ะะฐัััััั โ ะฐะบััะฐะปัะฝั (ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต)
โโโ ะะพััั โ ะฐะบััะฐะปัะฝั (ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต)

ะะตัะตะฝะธะต: ะฟัะธ ะฟะพัะฒะปะตะฝะธะธ ัะตัะธ โ ัะพะฝะพะฒัะน diff-ะทะฐะฟัะพั:
  GET /api/offline/sync-check?regions=altai,altai_krai&since=2026-02-24T...
  โ { updatedMarkers: 3, deletedMarkers: 1, newFavorites: 5 }
```

### ะคะฐะทะฐ 5: ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต (ะฑัะดััะตะต)

| ะขะตัะฝะพะปะพะณะธั | ะงัะพ ะดะฐัั | ะะพะณะดะฐ ะฝัะถะฝะพ |
|-----------|---------|------------|
| Service Worker | ะะตัะตัะฒะฐั tile-ะทะฐะฟัะพัะพะฒ ะฟัะพะทัะฐัะฝะพ | v2.0 โ ะบะพะณะดะฐ offline ััะฐะฑะธะปะตะฝ |
| Background Sync API | ะัะปะพะถะตะฝะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั ัะตัะฝะพะฒะธะบะพะฒ | v2.0 |
| PWA + Install | ะัะณะปัะดะธั ะบะฐะบ ะฝะฐัะธะฒะฝะพะต ะฟัะธะปะพะถะตะฝะธะต | v2.0 |
| App Shell ะบะตัะธัะพะฒะฐะฝะธะต | ะจัะธััั, ััะธะปะธ, JS ัะฐะฑะพัะฐัั ะพัะปะฐะนะฝ | v1.5 |
| OPFS (Origin Private FS) | ะััััะตะต IndexedDB, ะฝะตั ะปะธะผะธัะฐ 2 ะะ | v3.0 โ ะตัะปะธ ะพะฑััะผั ะฒััะฐัััั |

### ะััะธัะตะบัััะฝัะต ัะตัะตะฝะธั (ะฟัะธะฝัััะต):

| # | ะะพะฟัะพั | ะะตัะตะฝะธะต | ะะพัะตะผั |
|---|--------|---------|--------|
| 1 | ะะพะฝัะปะธะบัั | Last-write-wins | ะัะพััะพัะฐ ะดะปั MVP, ััะปะพะถะฝะธัั ะฟะพัะพะผ |
| 2 | Tile storage | IndexedDB | ะัะพััะฑัะฐัะทะตัะฝะพ, ะดะพััะฐัะพัะฝะพ ะดะปั zoom 6-12 |
| 3 | Service Worker | ะะตั (ะฟะพะบะฐ) | ะกะปะพะถะตะฝ ะฒ ะพัะปะฐะดะบะต, ะดะพะฑะฐะฒะธะผ ะฒ v2.0 |
| 4 | ะกะธะฝััะพะฝะธะทะฐัะธั ัะพัะพ | โค5 ะะ ััะฐะทั, >5 ะะ ะฟะพ Wi-Fi | ะะฐะปะฐะฝั ัะดะพะฑััะฒะฐ ะธ ััะฐัะธะบะฐ |
| 5 | TTL ัะฐะนะปะพะฒ | ะะตะท ะฐะฒัะพ-TTL, ัััะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต | ะขะฐะนะปั zoom 6-12 ะฟะพััะธ ะฝะต ะผะตะฝััััั |
| 6 | ะะตะดัะฟะปะธะบะฐัะธั ัะฐะนะปะพะฒ | ะะพ ะบะปััั `z/x/y` | ะญะบะพะฝะพะผะธั ะผะตััะฐ ะฟัะธ ะฝะตัะบะพะปัะบะธั ัะตะณะธะพะฝะฐั |
| 7 | Offline detection | `navigator.onLine` + fallback `/api/ping` | ะะฐะดัะถะฝะตะต, ัะตะผ ะพะดะธะฝ ะผะตัะพะด |

### ะะพััะดะพะบ ัะตะฐะปะธะทะฐัะธะธ (ะฑะตะท ัะฐะพัะฐ):

```
                    โโโ ะะะขะะะ โโโ
                    โ            โ
ะญัะฐะฟ 0: SVG-ะบะฐััะฐ   โโโโโโโโโโโโ  โ 85 ัะตะณะธะพะฝะพะฒ, ััะพะปะธัั, zoom/pan
                    โ            โ
                    โโโ MVP โโโโโโค
                    โ            โ
ะญัะฐะฟ 1: Tile API    โโโโโโโโโโโ  ะัะบะตะฝะด ะพัะดะฐัั ัะฐะนะปั ะฟะพ bounds
ะญัะฐะฟ 2: ะกะบะฐัะธะฒะฐะฝะธะต  โโโโโโโโโโโ  IndexedDB + ะฟัะพะณัะตัั
ะญัะฐะฟ 3: ะัะพัะผะพัั    โโโโโโโโโโโ  Leaflet ะธะท IndexedDB (ัะฐ ะถะต ะบะฐััะฐ!)
ะญัะฐะฟ 4: GPS         โโโโโโโโโโโ  ะัะปััะธััััะฐั ัะพัะบะฐ
                    โ            โ
                    โโโ v1.0 โโโโโค
                    โ            โ
ะญัะฐะฟ 5: ะะฐะฝะฝัะต      โโโโโโโโโโโ  ะะตัะบะธ + โ ะฒ bundle
ะญัะฐะฟ 6: ะกะพะทะดะฐะฝะธะต    โโโโโโโโโโโ  ะงะตัะฝะพะฒะธะบะธ ะพัะปะฐะนะฝ
ะญัะฐะฟ 7: ะกะธะฝััะพะฝะธะทะฐัะธัโโโโโโโโโโ  ะัะตัะตะดั + ะบะพะฝัะปะธะบัั (LWW)
                    โ            โ
                    โโโ v1.5 โโโโโค
                    โ            โ
ะญัะฐะฟ 8: ะฅัะฐะฝะธะปะธัะต   โโโโโโโโโโโ  ะฃะฟัะฐะฒะปะตะฝะธะต, ัะดะฐะปะตะฝะธะต, ัะฐะทะผะตัั
ะญัะฐะฟ 9: ะะฐัััััั    โโโโโโโโโโโ  ะขะตะผะฐัะธัะตัะบะธะต ะผะฐัััััั
ะญัะฐะฟ 10: PWA        โโโโโโโโโโโ  Service Worker + Install
```

**ะะปััะตะฒะพะน ะฟัะธะฝัะธะฟ:** ะบะฐะถะดัะน ััะฐะฟ ะฟัะธะฝะพัะธั ะฒะธะดะธะผัะน ัะตะทัะปััะฐั ะฟะพะปัะทะพะฒะฐัะตะปั.
ะญัะฐะฟั 1-4 ัะถะต ะดะฐัั ัะฐะฑะพัะฐัััั ะพัะปะฐะนะฝ-ะบะฐััั ั GPS.
ะญัะฐะฟั 5-7 ะดะพะฑะฐะฒะปััั ะผะตัะบะธ ะธ ะบะพะฝัะตะฝั.
ะญัะฐะฟั 8-10 โ ะฟะพะปะธัะพะฒะบะฐ ะธ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต.

---

## 16. ะััะพัะธั ะธะทะผะตะฝะตะฝะธะน

| ะะฐัะฐ | ะงัะพ ะธะทะผะตะฝะธะปะพัั |
|---|---|
| 2026-02-24 | ะะพะปะฝะฐั ะฟะตัะตัะฐะฑะพัะบะฐ ะบะพะฝัะตะฟัะธะธ: ะพั ยซะฟะพะบะฐะทะฐ ััะตะบะพะฒยป ะบ ยซะะฐัะผะฐะฝะฝะพะผั ะณะตะพะฑะปะพะณัยป |
| 2026-02-24 | ะะฟัะตะดะตะปะตะฝั zoom 6โ12, freemium-ะผะพะดะตะปั, ะฐััะธัะตะบัััะฐ ะดะฐะฝะฝัั |
| 2026-02-24 | ะะทะฑัะฐะฝะฝัะต ะผะตัะบะธ ะบะฐะบ ะพัะฝะพะฒะฐ ยซะฝะฐะนัะธ ะธะฝัะตัะตัะฝะพะตยป (ะฒะผะตััะพ ัะพะฟ-N ะฟะพะฟัะปััะฝัั) |
| 2026-02-24 | ะขัะธ ััะพะฒะฝั ะฟะพะดะฟะธัะตะน SVG-ะบะฐััั: ะพะฑะปะฐััะธ โ ััะพะปะธัั โ ัะฐะนะพะฝะฝัะต ัะตะฝััั |
| 2026-02-24 | ะะพะฝัะตะฟัะธั ัะตะผะฐัะธัะตัะบะธั ะผะฐัััััะพะฒ (ะะพะปะพัะพะต ะะพะปััะพ, ะขัะฐะฝััะธะฑ ะธ ะดั.) |
| 2026-02-24 | ะะพะฑะฐะฒะปะตะฝั ะบะพะพัะดะธะฝะฐัั 85 ััะพะปะธั ัะตะณะธะพะฝะพะฒ ะฒ `russiaRegionsGeo.ts` |
| 2026-02-24 | ะะพะปะฝัะต ะฝะฐะทะฒะฐะฝะธั ะพะฑะปะฐััะตะน/ะบัะฐัะฒ ะฒ label (ะะปะฐะดะธะผะธััะบะฐั ะพะฑะป., ะะตัะผัะบะธะน ะบัะฐะน) |
| 2026-02-24 | ยง8 ะะตัะฐะฝะธะบะฐ ะฟะตัะตะบะปััะตะฝะธั ะพะฝะปะฐะนะฝ/ะพัะปะฐะนะฝ: ะพะดะฝะฐ ะบะฐััะฐ Leaflet, ะดะฒะฐ ะธััะพัะฝะธะบะฐ |
| 2026-02-24 | ยง15 ะะธะทะฝะตะฝะฝัะน ัะธะบะป ะฟะพัะปะต ัะบะฐัะธะฒะฐะฝะธั: 5 ัะฐะท, ะฐััะธัะตะบัััะฝัะต ัะตัะตะฝะธั |

ะัะปะธ ะฟะพะดัะฒะตัะถะดะฐะตัะต โ ะฟัะธัััะฟะฐั ะบ ะฟัะฐะฒะบะฐะผ ะฟะพ ะฟัะธะพัะธัะตัั *Persist recorded tracks โ API ัะพััะฐะฝะตะฝะธั โ UI + ัะตััั*. ะัะปะธ ัะพัะธัะต ัะฝะฐัะฐะปะฐ ัะพะปัะบะพ PR/ะฟะปะฐะฝ โ ัะบะฐะถะตัะต ะฒ ะพัะฒะตัะต. 

*ะคะฐะนะป ัะพะทะดะฐะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ: OFFLANE_ROAD.md*